<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ssmdevices.software.network_profiling &#8212; ssmdevices v0.11</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="ssmdevices v0.11">
  <link rel="canonical" href="../../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../..//static/NISTStyle.css">
  <link rel="stylesheet" href="../../..//static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.software.network_profiling</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ssmdevices.software.network_profiling</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@authors: Dan Kuester &lt;daniel.kuester@nist.gov&gt;,</span>
<span class="sd">         Michael Voecks &lt;michael.voecks@nist.gov&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;IPerf2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IPerf3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IPerf2OnAndroid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IPerf2BoundPair&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TrafficProfiler_ClosedLoopTCP&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">AbstractContextManager</span><span class="p">,</span> <span class="n">suppress</span>


<span class="kn">import</span> <span class="nn">labbench</span> <span class="k">as</span> <span class="nn">lb</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">ssmdevices.lib</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">_networking</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">get_ipv4_address</span><span class="p">,</span>
        <span class="n">get_ipv4_occupied_ports</span><span class="p">,</span>
        <span class="n">list_network_interfaces</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">._networking</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">get_ipv4_address</span><span class="p">,</span>
        <span class="n">get_ipv4_occupied_ports</span><span class="p">,</span>
        <span class="n">list_network_interfaces</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="s2">&quot;_tcp_port_offset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span>
    <span class="n">_tcp_port_offset</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Make sure the performance counter is initialized</span>
<span class="n">perf_counter</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_IPerfBase</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">ShellBackend</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="n">server</span><span class="o">=</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="n">bind</span><span class="o">=</span><span class="s2">&quot;-B&quot;</span><span class="p">,</span>
        <span class="n">udp</span><span class="o">=</span><span class="s2">&quot;-u&quot;</span><span class="p">,</span>
        <span class="n">bit_rate</span><span class="o">=</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span>
        <span class="n">number</span><span class="o">=</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span>
        <span class="n">tcp_window_size</span><span class="o">=</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span>
        <span class="n">buffer_size</span><span class="o">=</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="n">nodelay</span><span class="o">=</span><span class="s2">&quot;-N&quot;</span><span class="p">,</span>
        <span class="n">mss</span><span class="o">=</span><span class="s2">&quot;-M&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># address and network interface parameters</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">NetworkAddress</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_port</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;client host address (set None if server=True)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;True to run as a server&quot;</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">5201</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;network port&quot;</span><span class="p">)</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;bind connection to specified IP&quot;</span><span class="p">)</span>

    <span class="nb">format</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">),</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;data unit prefix in bits (k, m, g), bytes (K, M, G), or None for auto&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># timing and duration</span>
    <span class="c1"># (for time, default=None even though we know the default, because setting 10s conflicts with `number`)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mi">16535</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;send duration (s) before quitting (default: 10)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the number of bytes to transmit before quitting&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">interval</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;seconds between throughput reports&quot;</span>
    <span class="p">)</span>

    <span class="c1"># high level buffer commands</span>
    <span class="n">udp</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;if True, to use UDP instead of TCP&quot;</span><span class="p">)</span>
    <span class="n">bit_rate</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;maximum bit rate (accepts KMG unit suffix; defaults 1Mbit/s UDP, no limit for TCP)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;buffer size (bytes) when generating traffic&quot;</span>
    <span class="p">)</span>

    <span class="c1"># TCP parameters</span>
    <span class="n">tcp_window_size</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;window / socket size in bytes (default OS dependent?)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nodelay</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set True to use nodelay (TCP traffic only)&quot;</span><span class="p">)</span>
    <span class="n">mss</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;minimum segment size (bytes)=MTU-40, TCP only&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_flags</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">duration</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span>
            <span class="n">background</span><span class="o">=</span><span class="ow">not</span> <span class="n">block</span><span class="p">,</span>
            <span class="n">pipe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">respawn</span><span class="o">=</span><span class="ow">not</span> <span class="n">block</span><span class="p">,</span>
            <span class="n">check_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;update and validate value traits&quot;&quot;&quot;</span>

        <span class="c1"># port availability</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
            <span class="n">busy_ports</span> <span class="o">=</span> <span class="n">get_ipv4_occupied_ports</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="ow">in</span> <span class="n">busy_ports</span><span class="p">:</span>
                <span class="n">prev_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ports</span>
                <span class="c1"># find an open server port</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;requested port </span><span class="si">{</span><span class="n">prev_port</span><span class="si">}</span><span class="s2"> is in use - changing to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># parameter conflict checks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;must set exactly one of (a) client operation by setting resource=&quot;(hostname here)&quot;, &#39;</span>
                <span class="s2">&quot;or (b) server operation by setting server=True&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the TCP MSS setting is incompatible with UDP&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelay</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the TCP nodelay setting is incompatible with UDP&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;iperf may work improperly when setting udp=True with buffer_size&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;iperf does not support setting bit_rate in TCP&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;iperf server does not support the `time` argument&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;iperf server does not support the `number` argument&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="IPerf3"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf3">[docs]</a><span class="k">class</span> <span class="nc">IPerf3</span><span class="p">(</span><span class="n">_IPerfBase</span><span class="p">,</span> <span class="n">binary_path</span><span class="o">=</span><span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;iperf3.exe&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run an instance of iperf3, collecting output data in a background thread.</span>
<span class="sd">    When running as an iperf client (server=False),</span>
<span class="sd">    The default value is the path that installs with 64-bit cygwin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FLAGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_IPerfBase</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="s2">&quot;-J&quot;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="n">zerocopy</span><span class="o">=</span><span class="s2">&quot;-Z&quot;</span><span class="p">)</span>

    <span class="c1"># IPerf3 only</span>
    <span class="n">reverse</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;run in reverse mode (server sends, client receives)&quot;</span>
    <span class="p">)</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output data in JSON format&quot;</span><span class="p">)</span>
    <span class="n">zerocopy</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use a &#39;zero copy&#39; method of sending data&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IPerf2"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2">[docs]</a><span class="k">class</span> <span class="nc">IPerf2</span><span class="p">(</span><span class="n">_IPerfBase</span><span class="p">,</span> <span class="n">binary_path</span><span class="o">=</span><span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;iperf.exe&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run an instance of iperf, collecting output data in a background thread.</span>
<span class="sd">    When running as an iperf client (server=False),</span>
<span class="sd">    The default value is the path that installs with 64-bit cygwin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FLAGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">_IPerfBase</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span>
        <span class="n">bidirectional</span><span class="o">=</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span>
        <span class="n">report_style</span><span class="o">=</span><span class="s2">&quot;-y&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">DATAFRAME_COLUMNS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;jitter_milliseconds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datagrams_lost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datagrams_sent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datagrams_loss_percentage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datagrams_out_of_order&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">bidirectional</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;send and receive simultaneously&quot;</span>
    <span class="p">)</span>
    <span class="n">report_style</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="s2">&quot;C&quot;</span><span class="p">,</span>
        <span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&quot;C&quot; for DataFrame table output, None for formatted text&#39;</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="IPerf2.profile"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="IPerf2.read_stdout"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;retreive text from standard output, and parse into a pandas DataFrame if self.report_style is None&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">())</span></div>

<div class="viewcode-block" id="IPerf2._format_output"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2._format_output">[docs]</a>    <span class="k">def</span> <span class="nf">_format_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pack stdout into a pandas DataFrame if self.report_style == &#39;C&#39;&quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="c1"># otherwise a dataframe</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source_address&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source_port&quot;</span><span class="p">,</span>
            <span class="s2">&quot;destination_address&quot;</span><span class="p">,</span>
            <span class="s2">&quot;destination_port&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transferred_bytes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bits_per_second&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATAFRAME_COLUMNS</span>
        <span class="c1">#</span>
        <span class="c1"># columns = [&#39;iperf_&#39; + c for c in columns]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">StringIO</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span>
        <span class="p">)</span>

        <span class="c1"># throw out the last row (potantially a summary of the previous rows)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="s2">&quot;transferred_bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;test_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">TimedeltaIndex</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div></div>


<div class="viewcode-block" id="IPerf2OnAndroid"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid">[docs]</a><span class="k">class</span> <span class="nc">IPerf2OnAndroid</span><span class="p">(</span><span class="n">IPerf2</span><span class="p">,</span> <span class="n">binary_path</span><span class="o">=</span><span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;adb.exe&quot;</span><span class="p">)):</span>
    <span class="c1"># leave this as a string to avoid validation pitfalls if the host isn&#39;t POSIXey</span>
    <span class="n">remote_binary_path</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;/data/local/tmp/iperf&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="IPerf2OnAndroid.profile"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_flags</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">duration</span><span class="p">))</span>

        <span class="c1"># the same flags as in IPerf, we just need to prepend a couple of other arguments first</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span>
            <span class="n">background</span><span class="o">=</span><span class="ow">not</span> <span class="n">block</span><span class="p">,</span>
            <span class="n">pipe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">respawn</span><span class="o">=</span><span class="ow">not</span> <span class="n">block</span><span class="p">,</span>
            <span class="n">check_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># wait for output before returning</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;network&quot;</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no network connectivity in UE&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.open"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open an adb connection to the handset, copy the iperf binary onto the phone, and</span>
<span class="sd">        verify that iperf executes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#            self._logger.warning(&#39;TODO: need to fix setup for android iperf, but ok for now&#39;)</span>
        <span class="c1">#            devices = self.pipe(&#39;devices&#39;).strip().rstrip().splitlines()[1:]</span>
        <span class="c1">#            if len(devices) == 0:</span>
        <span class="c1">#                raise Exception(&#39;adb lists no devices. is the UE connected?&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;awaiting USB connection to handset&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

        <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;copying iperf onto phone&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;android&quot;</span><span class="p">,</span> <span class="s2">&quot;iperf&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_binary_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;777&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Check that it&#39;s executable</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pipe</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;/system/bin/sh&quot;</span><span class="p">):</span>
            <span class="c1"># adb dumps both stderr and stdout from the handset into stdout, so we get little</span>
            <span class="c1"># from monitoring. if iperf ran correctly, however, there is no message from sh</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adb shell iperf --help failed: </span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;phone is ready to execute iperf&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.kill"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kill the local process and the iperf process on the UE.&quot;&quot;&quot;</span>

        <span class="c1"># Kill the local adb process as normal</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

        <span class="c1"># Now&#39;s where the fun really starts</span>

        <span class="c1"># Find and kill processes on the UE</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_binary_path</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;kill&quot;</span><span class="p">,</span> <span class="s2">&quot;-9&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;killing zombie iperf: </span><span class="si">{stdout}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># Wait for any iperf zombie processes to die</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">wait_time</span> <span class="ow">and</span> <span class="n">wait_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;iperf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                    <span class="s2">&quot;timeout waiting for iperf process termination on UE&quot;</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.read_stdout"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;adb seems to forward stderr as stdout. Filter out some undesired</span>
<span class="sd">        resulting status messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">ShellBackend</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># remove extra output added by adb</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;stdout: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.wait_for_cell_data"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.wait_for_cell_data">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_cell_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until cellular data is available</span>

<span class="sd">        :param timeout: how long to wait for a connection before raising a Timeout error</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;waiting for cellular data connection&quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;dumpsys&quot;</span><span class="p">,</span> <span class="s2">&quot;telephony.registry&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

            <span class="n">con</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                <span class="s2">&quot;mDataConnectionState=([\-0-9]+)&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">con</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;phone did not connect for cellular data before timeout&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;cellular data available after </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.reboot"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reboot the device.</span>

<span class="sd">        :param block: if truey, block until the device is ready to accept commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rebooting&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;reboot&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerf2OnAndroid.wait_for_device"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2OnAndroid.wait_for_device">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until the device is ready to accept commands</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;wait-for-device&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="IPerf2BoundPair"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair">[docs]</a><span class="k">class</span> <span class="nc">IPerf2BoundPair</span><span class="p">(</span><span class="n">IPerf2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run an iperf client and a server on the host computer at the same time. They are</span>
<span class="sd">    bound to interfaces in order to ensure that data is routed between them, not through</span>
<span class="sd">    localhost or any other interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># add other settings</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;unused - use sender and receiver instead&quot;</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">NetworkAddress</span><span class="p">(</span>
        <span class="n">accepts_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the ip address where the server listens&quot;</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">NetworkAddress</span><span class="p">(</span>
        <span class="n">accepts_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the ip address from which the client sends data&quot;</span>
    <span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="IPerf2BoundPair.open"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">IPerf2</span><span class="p">(),</span> <span class="n">server</span><span class="o">=</span><span class="n">IPerf2</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">sequentially</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerf2BoundPair.close"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;NoneType&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="IPerf2BoundPair.kill"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;server&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;client&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerf2BoundPair.running"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.running">[docs]</a>    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">running</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">running</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerf2BoundPair.start"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_pair</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2BoundPair.read_stdout"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">()</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># a single merged DataFrame</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_dataframes</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># a dictionary of text results</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2BoundPair._merge_dataframes"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair._merge_dataframes">[docs]</a>    <span class="k">def</span> <span class="nf">_merge_dataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;client_&quot;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="s2">&quot;timestamp&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>

        <span class="n">server</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;server_&quot;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="s2">&quot;timestamp&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf2BoundPair._setup_pair"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.IPerf2BoundPair._setup_pair">[docs]</a>    <span class="k">def</span> <span class="nf">_setup_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">BlockingIOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> is already running&quot;</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="n">client_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_validate_flags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_validate_flags</span><span class="p">()</span></div></div>

        <span class="c1"># self.children[&#39;client&#39;].port = self.children[&#39;server&#39;].port</span>

        <span class="c1"># cycle the port for the next call, because windows takes a couple of</span>
        <span class="c1"># minutes to release bound ports after use</span>


<span class="n">m1</span> <span class="o">=</span> <span class="mh">0x5555555555555555</span>
<span class="n">m2</span> <span class="o">=</span> <span class="mh">0x3333333333333333</span>
<span class="n">m4</span> <span class="o">=</span> <span class="mh">0x0F0F0F0F0F0F0F0F</span>
<span class="n">m8</span> <span class="o">=</span> <span class="mh">0x00FF00FF00FF00FF</span>
<span class="n">m16</span> <span class="o">=</span> <span class="mh">0x0000FFFF0000FFFF</span>
<span class="n">m32</span> <span class="o">=</span> <span class="mh">0x00000000FFFFFFFF</span>
<span class="n">h01</span> <span class="o">=</span> <span class="mh">0x0101010101010101</span>


<span class="k">def</span> <span class="nf">bit_errors</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See: https://en.wikipedia.org/wiki/Hamming_weight&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1">#    a1 = np.frombuffer(buf1,dtype=&#39;uint64&#39;)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">m2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m4</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">h01</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TrafficProfiler_ClosedLoop</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Profile closed-loop traffic between two network interfaces</span>
<span class="sd">    on this computer. Takes advantage of the system clock as a common</span>
<span class="sd">    basis for traffic delay measurement, with uncertainty approximately</span>
<span class="sd">    equal to the system time resolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;the name of the network interface that will send data&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the name of the network interface that will receive data&quot;</span>
    <span class="p">)</span>
    <span class="n">receive_side</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;which of the server or the client does the receiving&quot;</span><span class="p">,</span>
        <span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TCP or UDP port for networking, or 0 to let the operating system choose&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;skipd - use sender and receiver instead&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
        <span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;timeout before aborting the test&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">tcp_nodelay</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set True to disable Nagle&#39;s algorithm&quot;</span><span class="p">)</span>
    <span class="n">sync_each</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;synchronize the start times of the send and receive threads for each buffer at the cost of throughput&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">delay</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;wait time before profiling&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">(server=&#39;</span><span class="si">{server}</span><span class="s2">&#39;,client=&#39;</span><span class="si">{client}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_traffic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a background thread that runs a one-way traffic test.</span>

<span class="sd">        It will end when `count` buffers have been tested, `duration`</span>
<span class="sd">        time has elapsed, or `stop_traffic` is called. To retrieve the</span>
<span class="sd">        traffic data, call `stop_traffic`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_background_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_background_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">listener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_sockets</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
                <span class="n">client_sock</span><span class="o">=</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="n">server_sock</span><span class="o">=</span><span class="n">server_sock</span><span class="p">,</span>
                <span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span>
                <span class="n">end_event</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_background_event</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_background_event&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_background_queue&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span><span class="s2">&quot;no traffic history, start a run first&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ret</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_dataframe</span><span class="p">(</span>
                <span class="n">ret</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_background_queue&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span><span class="s2">&quot;no traffic running, start a run first&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_background_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">suppress_matching_arg0</span><span class="p">(</span><span class="n">AbstractContextManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to suppress specified exceptions that must also match</span>
<span class="sd">        a specified first argument.</span>

<span class="sd">    After the exception is suppressed, execution proceeds with the next</span>
<span class="sd">    statement following the with statement.</span>

<span class="sd">         with suppress(FileNotFoundError):</span>
<span class="sd">             os.remove(somefile)</span>
<span class="sd">         # Execution still resumes here if the file was already removed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exceptions</span><span class="p">,</span> <span class="n">arg0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg0</span> <span class="o">=</span> <span class="n">arg0</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exctype</span><span class="p">,</span> <span class="n">excinst</span><span class="p">,</span> <span class="n">exctb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exctype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg0</span> <span class="o">==</span> <span class="n">excinst</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">ServerConnectionError</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ClientConnectionError</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PortBusyError</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP">[docs]</a><span class="k">class</span> <span class="nc">TrafficProfiler_ClosedLoopTCP</span><span class="p">(</span><span class="n">TrafficProfiler_ClosedLoop</span><span class="p">):</span>
    <span class="n">_server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">PORT_WINERRS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10013</span><span class="p">,</span> <span class="mi">10048</span><span class="p">)</span>
    <span class="n">CONN_WINERRS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10051</span><span class="p">,)</span>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP._close_sockets"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP._close_sockets">[docs]</a>    <span class="k">def</span> <span class="nf">_close_sockets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sockets</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="n">sockets</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">with</span> <span class="n">suppress_matching_arg0</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">arg0</span><span class="o">=</span><span class="mi">10057</span><span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">buf</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failed to flush socket before closing&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">suppress_matching_arg0</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">arg0</span><span class="o">=</span><span class="mi">10057</span><span class="p">),</span> <span class="n">suppress_matching_arg0</span><span class="p">(</span>
                <span class="ne">OSError</span><span class="p">,</span> <span class="n">arg0</span><span class="o">=</span><span class="s2">&quot;timed out&quot;</span>
            <span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">suppress_matching_arg0</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">arg0</span><span class="o">=</span><span class="mi">10057</span><span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_receive_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_side</span> <span class="o">==</span> <span class="s2">&quot;server&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP._open_sockets"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP._open_sockets">[docs]</a>    <span class="k">def</span> <span class="nf">_open_sockets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect the supplied client socket to the server.&quot;&quot;&quot;</span>

        <span class="k">global</span> <span class="n">_tcp_port_offset</span>

        <span class="n">server_ip</span> <span class="o">=</span> <span class="n">get_ipv4_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="n">get_ipv4_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="n">listen_sock</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="n">bytes_</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="n">tcp_nodelay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp_nodelay</span>

        <span class="n">client_done</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="n">server_done</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">listener</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Run a listener at the socket&quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Set the size of the buffer for this socket</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;created server socket with recv buffer size </span><span class="si">{</span><span class="n">bytes_</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">bufsize</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bufsize</span> <span class="o">&lt;</span> <span class="n">bytes_</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;recv buffer size is </span><span class="si">{</span><span class="n">bufsize</span><span class="si">}</span><span class="s2">, but need at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;binding listener to </span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

                <span class="c1"># start listening</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;winerror&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">winerror</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PORT_WINERRS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PortBusyError</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="k">return</span> <span class="n">sock</span>

        <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="n">listen_sock</span><span class="p">):</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">listen_sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;client start&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

                <span class="c1"># Basic flags</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="n">tcp_nodelay</span><span class="p">)</span>

                <span class="c1"># Set and verify the send buffer size</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">)</span>
                <span class="n">bytes_actual</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bytes_actual</span> <span class="o">!=</span> <span class="n">bytes_</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;client buffer size is </span><span class="si">{</span><span class="n">bytes_actual</span><span class="si">}</span><span class="s2">, but requested </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># binding to the specific port creates a conflict</span>
                    <span class="c1"># with the server, and a connection failure</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">client_ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ConnectionRefusedError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

                <span class="c1"># Do the connect</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

            <span class="c1"># This exception needs to come first, because it is a subclass</span>
            <span class="c1"># of OSError (at least on windows)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">bytes_</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;client socket timed out in attempt to connect to the server at </span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="ne">ConnectionRefusedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># Certain &quot;port busy&quot; errors are raised as OSError. Check whether</span>
            <span class="c1"># they match a whitelist of known port errors to map into port busy</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;connection failed between server </span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s2"> and client </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># Windows-specific errors</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;winerror&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">winerror</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PORT_WINERRS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">PortBusyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;winerror&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">winerror</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONN_WINERRS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="c1"># For everything else, we still need to clean up</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">bytes_</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>

            <span class="c1"># if this times out, some kind of exception should have been</span>
            <span class="c1"># raised in the server thread. leave quietly and allow the</span>
            <span class="c1"># exception to come from the server.</span>
            <span class="n">client_done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">server_done</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">bytes_</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">sock</span>

        <span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">listen_sock</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;server start&quot;</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Try to get a connection</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">listen_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.051</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">-</span> <span class="p">(</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span> <span class="o">=</span> <span class="n">listen_sock</span>
                        <span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">other_ip</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">listen_sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1">#                    except OSError as e:</span>
                    <span class="c1">#                        # Windows-specific errors</span>
                    <span class="c1">#                        if hasattr(e, &#39;winerror&#39;) and e.winerror in self.port_winerrs:</span>
                    <span class="c1">#                            self._logger.debug(f&#39;port {port} is inaccessible&#39;)</span>
                    <span class="c1">#                            raise PortBusyError</span>
                    <span class="c1">#                        else:</span>
                    <span class="c1">#                            raise</span>
                    <span class="c1">#                    except AttributeError:</span>
                    <span class="c1">#                        if listen_sock is None:</span>
                    <span class="c1">#                            raise ConnectionError(&#39;no listener to provide server connection socket&#39;)</span>
                    <span class="c1">#                        else:</span>
                    <span class="c1">#                            raise</span>

                    <span class="k">if</span> <span class="n">other_ip</span> <span class="o">==</span> <span class="n">client_ip</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">port</span> <span class="o">=</span> <span class="n">listen_sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;connection attempt from unexpected ip </span><span class="si">{</span><span class="n">other_ip</span><span class="si">}</span><span class="s2"> instead of </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">bytes_</span><span class="p">)</span>
                            <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">listen_sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;socket server received no connection attempt on </span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">listen_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listen_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

                <span class="c1"># Basic flags</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="c1">#            conn.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="n">tcp_nodelay</span><span class="p">)</span>

                <span class="c1"># Set and verify the send buffer size</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">)</span>
                <span class="n">bytes_actual</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bytes_actual</span> <span class="o">!=</span> <span class="n">bytes_</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;server buffer size is </span><span class="si">{</span><span class="n">bytes_actual</span><span class="si">}</span><span class="s2">, but requested </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">client_done</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="c1"># Suppress the server exception if the client is already</span>
                <span class="c1"># raising one</span>
                <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;server connection exception: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2"> (superceded by client exception)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">bytes_</span><span class="p">)</span>

            <span class="n">server_done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>

            <span class="k">return</span> <span class="n">conn</span>

        <span class="k">def</span> <span class="nf">open_</span><span class="p">():</span>
            <span class="k">global</span> <span class="n">_tcp_port_offset</span><span class="p">,</span> <span class="n">listen_sock</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">_tcp_port_offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">listen_sock</span> <span class="o">=</span> <span class="n">listener</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

            <span class="c1"># Keep trying on many ports</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">concurrently</span><span class="p">(</span>
                    <span class="n">lb</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">listen_sock</span><span class="o">=</span><span class="n">listen_sock</span><span class="p">),</span>
                    <span class="n">lb</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">listen_sock</span><span class="o">=</span><span class="n">listen_sock</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">listen_sock</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_tcp_port_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">_tcp_port_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5000</span>

            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;listener&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listen_sock</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">open_</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Allow chances to try other ports</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">PortBusyError</span><span class="p">,</span> <span class="mi">100</span><span class="p">)(</span><span class="n">open_</span><span class="p">)()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;server </span><span class="si">{</span><span class="n">server_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> accepted connection from client </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">perf_counter</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">PortBusyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;failed to connect on </span><span class="si">{retries}</span><span class="s2"> ports&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;listener&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP._run"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP._run">[docs]</a>    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client_sock</span><span class="p">,</span>
        <span class="n">server_sock</span><span class="p">,</span>
        <span class="n">buffer_size</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">end_event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;must pass at least one of duration, count, and end_event to specify end condition&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp_nodelay</span> <span class="ow">and</span> <span class="n">buffer_size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mss</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;with tcp_nodelay enabled, set buffer_size at least as large as the MSS (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mss</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_interface</span><span class="p">:</span>
            <span class="n">send_sock</span><span class="p">,</span> <span class="n">recv_sock</span> <span class="o">=</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">server_sock</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">send_sock</span><span class="p">,</span> <span class="n">recv_sock</span> <span class="o">=</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span>

        <span class="n">t_start</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># Are we running in the background?</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">end_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Pull some parameters and thread sync objects into the namespace</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="n">bytes_</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_each</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
        <span class="n">rx_ready</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="n">tx_ready</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">end_event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="n">except_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">check_status</span><span class="p">():</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Bail if the sender hit an exception</span>
            <span class="k">if</span> <span class="n">except_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">traffic_done</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">background</span> <span class="ow">and</span> <span class="n">end_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;=</span> <span class="n">duration</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">receiver</span><span class="p">():</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">finishes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rx_buffer0_finishes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rx_buffer_sizes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rx_buffers</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="nf">do_sync</span><span class="p">():</span>
                <span class="n">check_status</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
                    <span class="n">t_sync</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                    <span class="n">rx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">tx_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_sync</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                            <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for sender sync&quot;</span><span class="p">)</span>
                    <span class="n">tx_ready</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">single</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Receive a single buffer of data&quot;&quot;&quot;</span>
                <span class="n">bytes_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
                <span class="n">do_sync</span><span class="p">()</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Receive rx_buffers until we receive the full send buffer</span>
                <span class="k">while</span> <span class="n">bytes_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;timeout while waiting to receive </span><span class="si">{</span><span class="n">bytes_left</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">bytes_</span><span class="si">}</span><span class="s2"> bytes&quot;</span>
                        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bytes_left</span> <span class="o">-=</span> <span class="n">recv_sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="n">bytes_left</span><span class="p">:],</span> <span class="n">bytes_left</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">rx_buffer0_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span> <span class="o">-</span> <span class="n">bytes_left</span>
                            <span class="n">t1</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t2</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

                <span class="k">return</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">rx_buffer0_size</span><span class="p">,</span> <span class="n">i</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">do_sync</span><span class="p">()</span>

                <span class="c1"># One to the wind</span>
                <span class="n">single</span><span class="p">()</span>
                <span class="n">rx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Receive the test data</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">traffic_done</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">rx_buffer0_size</span><span class="p">,</span> <span class="n">rx_buffer_count</span> <span class="o">=</span> <span class="n">single</span><span class="p">()</span>
                    <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
                    <span class="n">rx_buffer0_finishes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                    <span class="n">finishes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                    <span class="n">rx_buffer_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rx_buffer0_size</span><span class="p">)</span>
                    <span class="n">rx_buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rx_buffer_count</span><span class="p">)</span>

                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># One to the wind</span>
            <span class="c1">#                single()</span>

            <span class="k">except</span> <span class="n">lb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() ended by master thread&quot;</span>
                <span class="p">)</span>
                <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">end_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
                    <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">raise</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;t_rx_start&quot;</span><span class="p">:</span> <span class="n">starts</span><span class="p">,</span>
                <span class="s2">&quot;t_rx_end_buffer0&quot;</span><span class="p">:</span> <span class="n">rx_buffer0_finishes</span><span class="p">,</span>
                <span class="s2">&quot;t_rx_end&quot;</span><span class="p">:</span> <span class="n">finishes</span><span class="p">,</span>
                <span class="s2">&quot;rx_buffer0_size&quot;</span><span class="p">:</span> <span class="n">rx_buffer_sizes</span><span class="p">,</span>
                <span class="s2">&quot;rx_buffer_count&quot;</span><span class="p">:</span> <span class="n">rx_buffers</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">sender</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;This runs in the receive thread, with the socket connected.&quot;&quot;&quot;</span>
            <span class="n">start_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">finish_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">do_sync</span><span class="p">():</span>
                <span class="n">check_status</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
                    <span class="n">t_sync</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">rx_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_sync</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                            <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for receive sync&quot;</span><span class="p">)</span>
                    <span class="n">rx_ready</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">tx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">single</span><span class="p">():</span>
                <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bytes</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
                <span class="n">do_sync</span><span class="p">()</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">send_sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;timed out attempting to send data&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">return</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ex</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">do_sync</span><span class="p">()</span>

                <span class="c1"># Throwaway buffer</span>
                <span class="n">single</span><span class="p">()</span>
                <span class="n">tx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">traffic_done</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                    <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">single</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ex</span>

                    <span class="n">start_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
                    <span class="n">finish_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>

                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Throwaway buffer</span>
            <span class="c1">#                single()</span>

            <span class="k">except</span> <span class="n">lb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() ended by master thread&quot;</span>
                <span class="p">)</span>
                <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">end_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;suppressed exception in sender: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="n">bytes_</span><span class="p">,</span>
                <span class="s2">&quot;t_tx_start&quot;</span><span class="p">:</span> <span class="n">start_timestamps</span><span class="p">,</span>
                <span class="s2">&quot;t_tx_end&quot;</span><span class="p">:</span> <span class="n">finish_timestamps</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">background_thread</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">end_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">concurrently</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">traceback_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_background_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;finished traffic test of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> buffers of </span><span class="si">{</span><span class="n">bytes_</span><span class="si">}</span><span class="s2"> bytes&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;background thread exception - traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_background_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span>
                    <span class="n">send_sock</span><span class="p">,</span> <span class="n">recv_sock</span><span class="p">,</span> <span class="n">listen_sock</span><span class="p">,</span> <span class="n">bytes_</span><span class="o">=</span><span class="n">buffer_size</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;background thread finished&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">background_thread</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">tx_ready</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">rx_ready</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;first buffer sent after </span><span class="si">{</span><span class="n">perf_counter</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_start</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">concurrently</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">traceback_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;t_tx_start&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;finished traffic test of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> buffers of </span><span class="si">{</span><span class="n">bytes_</span><span class="si">}</span><span class="s2"> bytes&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP.profile_count"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP.profile_count">[docs]</a>    <span class="k">def</span> <span class="nf">profile_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sends `count` buffers of size `buffer_size` bytes</span>
<span class="sd">        and returns profiling information&quot;</span>

<span class="sd">        Arguments:</span>

<span class="sd">            buffer_size (int): number of bytes to send in each buffer</span>

<span class="sd">            count (int): the number of buffers to send</span>

<span class="sd">        :returns: a DataFrame indexed on PC time containing columns &#39;bits_per_second&#39;, &#39;duration&#39;, &#39;delay&#39;, &#39;queuing_duration&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Connect all the sockets</span>
        <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">listener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_sockets</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
                <span class="n">client_sock</span><span class="o">=</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="n">server_sock</span><span class="o">=</span><span class="n">server_sock</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                <span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_dataframe</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP.profile_duration"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP.profile_duration">[docs]</a>    <span class="k">def</span> <span class="nf">profile_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sends buffers of size `buffer_size` bytes until</span>
<span class="sd">        `duration` seconds have elapsed, and returns profiling information&quot;</span>

<span class="sd">        Arguments:</span>

<span class="sd">            buffer_size (int): number of bytes to send in each buffer</span>

<span class="sd">            duration (float): the minimum number of seconds to spend profiling</span>

<span class="sd">        :returns: a DataFrame indexed on PC time containing columns &#39;bits_per_second&#39;, &#39;duration&#39;, &#39;delay&#39;, &#39;queuing_duration&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#        t0 = perf_counter()</span>

        <span class="c1"># Connect all the sockets</span>
        <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">listener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_sockets</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
                <span class="n">client_sock</span><span class="o">=</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="n">server_sock</span><span class="o">=</span><span class="n">server_sock</span><span class="p">,</span>
                <span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_dataframe</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP._make_dataframe"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP._make_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">_make_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_data</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;making dataframe&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">worker_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;the run did not return data&quot;</span><span class="p">)</span>

        <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">worker_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bytes&quot;</span><span class="p">)</span>

        <span class="c1"># Race condition may make the lengths different by 1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">worker_data</span><span class="p">[</span><span class="s2">&quot;t_tx_start&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">worker_data</span><span class="p">[</span><span class="s2">&quot;t_rx_start&quot;</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">worker_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">worker_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker_data</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">count</span><span class="p">]</span>

        <span class="c1"># Compute elapsed timings, shift timestamps, etc.</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">worker_data</span><span class="p">)</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">TimedeltaIndex</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">t_tx_start</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">start</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_end</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_start</span>

        <span class="c1"># The average data rate after the first partial receive buffer</span>
        <span class="n">late_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">rx_buffer0_size</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_end</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_end_buffer0</span>
        <span class="p">)</span>

        <span class="c1"># Estimate the clock value immediately before the data arrived at the</span>
        <span class="c1"># receive socket based on the remainder of the data</span>
        <span class="n">est_rx_buffer0_start</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_end_buffer0</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">rx_buffer0_size</span> <span class="o">/</span> <span class="n">late_rate</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;bits_per_second&quot;</span><span class="p">:</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">buffer_size</span> <span class="o">/</span> <span class="n">duration</span><span class="p">,</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                <span class="s2">&quot;delay&quot;</span><span class="p">:</span> <span class="n">est_rx_buffer0_start</span>
                <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_tx_start</span><span class="p">,</span>  <span class="c1"># ret.t_rx_start-ret.t_tx_start,</span>
                <span class="s2">&quot;queuing_duration&quot;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_tx_end</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_tx_start</span><span class="p">,</span>
                <span class="s2">&quot;rx_buffer_count&quot;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">rx_buffer_count</span><span class="p">,</span>
                <span class="s2">&quot;t_rx_end_buffer0&quot;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">t_rx_end_buffer0</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP.mss"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP.mss">[docs]</a>    <span class="k">def</span> <span class="nf">mss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtu</span><span class="p">()</span> <span class="o">-</span> <span class="mi">40</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP.mtu"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP.mtu">[docs]</a>    <span class="k">def</span> <span class="nf">mtu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iface</span> <span class="o">=</span> <span class="n">list_network_interfaces</span><span class="p">(</span><span class="s2">&quot;interface&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_interface</span><span class="p">][</span>
            <span class="s2">&quot;interface&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_if_stats</span><span class="p">()[</span><span class="n">iface</span><span class="p">]</span><span class="o">.</span><span class="n">mtu</span></div>

<div class="viewcode-block" id="TrafficProfiler_ClosedLoopTCP.wait_for_interfaces"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/network_profiling/index.html#ssmdevices.software.TrafficProfiler_ClosedLoopTCP.wait_for_interfaces">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="ne">ConnectionRefusedError</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">socks</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">until_timeout</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_sockets</span><span class="p">)()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_sockets</span><span class="p">(</span><span class="o">*</span><span class="n">socks</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;interfaces ready after </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">elapsed</span></div></div>


<span class="c1"># Examples</span>
<span class="c1"># ClosedLoopNetworkingTest example</span>
<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     lb.show_messages(&#39;debug&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     net = ClosedLoopTCPBenchmark(server=&#39;WLAN_AP_DUT&#39;,</span>
<span class="c1">#                                  client=&#39;WLAN_Client_DUT&#39;,</span>
<span class="c1">#                                  receiver=&#39;WLAN_Client_DUT&#39;,</span>
<span class="c1">#                                  port=0,</span>
<span class="c1">#                                  tcp_nodelay=True)</span>
<span class="c1">#</span>
<span class="c1">#     mss_mults = []</span>
<span class="c1">#     binary_mults = []</span>
<span class="c1">#     with net:</span>
<span class="c1">#         for j in range(1):</span>
<span class="c1">#             net.start_traffic(1460 * 10)</span>
<span class="c1">#             print(net.is_running())</span>
<span class="c1">#             lb.sleep(3)</span>
<span class="c1">#             print(net.is_running())</span>
<span class="c1">#             ret = net.stop_traffic()</span>
<span class="c1">#             print(net.is_running())</span>
<span class="c1">#            lb.logger.info(f&#39;test {j}&#39;)</span>
<span class="c1">#            ret = mss_mults.append(net.acquire(1460*10,count=1000))</span>
<span class="c1">#            net.bytes = 4096*4</span>
<span class="c1">#            binary_mults.append(net.acquire(1000))</span>

<span class="c1">#            traffic = net.acquire(50)</span>
<span class="c1">#            pylab.figure()</span>
<span class="c1">#            traffic.hist(bins=51)</span>
<span class="c1">#            traffic[[&#39;duration&#39;,&#39;delay&#39;]].plot(marker=&#39;.&#39;, lw=0)</span>
<span class="c1">#            traffic[&#39;rate&#39;] = net.bytes/traffic.duration*8/1e6</span>
<span class="c1">#            print(f&#39;{traffic.rate.median()} +/- {2*traffic.rate.std()} Mbps&#39;)</span>
<span class="c1">#            print(&#39;medians\n&#39;,traffic.median(axis=0))</span>

<span class="c1"># IPerf2 example</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">lb</span><span class="o">.</span><span class="n">show_messages</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
    <span class="c1">#    ips = IPerf2(server=True, port=5050, interval=0.25, udp=True)</span>

    <span class="n">net</span> <span class="o">=</span> <span class="n">TrafficProfiler_ClosedLoopTCP</span><span class="p">(</span>
        <span class="n">server</span><span class="o">=</span><span class="s2">&quot;Ethernet&quot;</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="s2">&quot;Ethernet&quot;</span><span class="p">,</span>
        <span class="n">receive_side</span><span class="o">=</span><span class="s2">&quot;server&quot;</span><span class="p">,</span>  <span class="c1"># &quot;WLAN_Client_DUT&quot;,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">tcp_nodelay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">net</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">mtu</span><span class="p">(),</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

    <span class="c1"># ipc = IPerf2(&quot;127.0.0.1&quot;, port=5054, time=10, interval=0.25)</span>
    <span class="c1"># ipc.open()</span>

    <span class="c1"># ipc.acquire(block=False)</span>

    <span class="c1"># time.sleep(5)</span>
    <span class="c1"># ipc.kill()</span>
    <span class="c1"># ipc_result = ipc.read_stdout()</span>

    <span class="c1">#    with ipc:</span>
    <span class="c1">#         for i in range(1):</span>
    <span class="c1">#             # ips.start()</span>
    <span class="c1">#             lb.sleep(1)</span>
    <span class="c1">#             ipc.start()</span>

    <span class="c1">#             lb.sleep(5)</span>

    <span class="c1">#             ipc.kill()</span>
    <span class="c1">#             # ips.kill()</span>

    <span class="c1">#             # ips_result = ips.read_stdout()</span>
    <span class="c1">#             ipc_result = ipc.read_stdout()</span>

    <span class="c1"># #    print(ips_result)</span>
    <span class="c1"># print(ipc_result)</span>

<span class="c1"># # IPerf2BoundPair example</span>
<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     # &#39;debug&#39; shows a lot of info to the screen.</span>
<span class="c1">#     # set to &#39;info&#39; for less, or &#39;warning&#39; for even less</span>
<span class="c1">#     lb.show_messages(&#39;debug&#39;)</span>

<span class="c1">#     # When both network interfaces run on the same computer,</span>
<span class="c1">#     # it is convenient to use IPerf2BoundPair, which runs both</span>
<span class="c1">#     # an iperf server and an iperf client. each socket is bound</span>
<span class="c1">#     # to these interfaces to ensure that traffic is routed through</span>
<span class="c1">#     # the devices under test.</span>
<span class="c1">#     iperf = IPerf2BoundPair(</span>
<span class="c1">#         server=&#39;127.0.0.1&#39;,</span>
<span class="c1">#         client=&#39;127.0.0.1&#39;,</span>

<span class="c1">#         ### the parameters below set the corresponding iperf command line flags</span>
<span class="c1">#         # tcp_window_size=8196# -w (default unknown?)</span>
<span class="c1">#         # buffer_size=&#39;16k&#39;   # -l (default unknown? possible strange results for UDP)</span>
<span class="c1">#         interval=1,         # -i (default is no output until the end of process)</span>
<span class="c1">#         # bidirectional=True, # -d (default is False)</span>
<span class="c1">#         udp=True,           # -u (default is False (TCP))</span>
<span class="c1">#         # bit_rate=&#39;1M&#39;       # -b (default is no bit rate throttling)</span>
<span class="c1">#         time=10,            # -t (how long to run the iperf client; iperf&#39;s default is 10s)</span>
<span class="c1">#         # report_style=&#39;C&#39;,   # -y (we set this from python to &#39;C&#39; by default for CSV table; set to None for text output)</span>
<span class="c1">#         # number=-1,        # -n (by default, iperf uses -t to determine client test length; set -1 to run until killed)</span>
<span class="c1">#         # nodelay=True,       # -N (default is False; TCP only)</span>
<span class="c1">#         # mss=1460,           # -M (default 1460? - TCP only, of course)</span>
<span class="c1">#     )</span>

<span class="c1">#     # Approach 1: blocking (pipe).</span>
<span class="c1">#     # Calling pipe() doesn&#39;t return until the test is done.</span>
<span class="c1">#     # data = iperf.pipe(time=3)</span>

<span class="c1">#     # Approach 2: non-blocking (background) call</span>
<span class="c1">#     # background() returns immediately while iperf runs in the background.</span>
<span class="c1">#     # this allows other tasks here in the main thread</span>

<span class="c1">#     with iperf:</span>
<span class="c1">#         iperf.start(time=3)</span>
<span class="c1">#         time.sleep(4) # replace this with other code for automating other equipment</span>
<span class="c1">#         iperf.kill()</span>
<span class="c1">#         data = iperf.read_stdout()</span>

<span class="c1">#         # data is returned as a pandas dataframe.</span>
<span class="c1">#         # you can just dump it directly to a csv</span>
<span class="c1">#         data.to_csv(r&#39;c:\users\dkuester\output.csv&#39;)</span>

<span class="c1">#         # or make a plot</span>
<span class="c1">#         data.plot(x=&#39;timestamp&#39;, y=[&#39;server_bits_per_second&#39;, &#39;client_bits_per_second&#39;])</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.software.network_profiling</a></li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>