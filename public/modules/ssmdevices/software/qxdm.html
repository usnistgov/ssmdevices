<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ssmdevices.software.qxdm &#8212; ssmdevices v0.11</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="ssmdevices v0.11">
  <link rel="canonical" href="../../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../..//static/NISTStyle.css">
  <link rel="stylesheet" href="../../..//static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.software.qxdm</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ssmdevices.software.qxdm</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Basic control over the QXDM software.</span>

<span class="sd">Author: Paul Blanchard (paul.blanchard@nist.gov)</span>
<span class="sd">Edits by Dan Kuester (dkuester@nist.gov)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;QXDM&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">labbench</span> <span class="k">as</span> <span class="nn">lb</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">psutil</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">ET</span>


<span class="k">class</span> <span class="nc">QPST</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Win32ComDevice</span><span class="p">,</span> <span class="n">com_object</span><span class="o">=</span><span class="s2">&quot;QPSTAtmnServer.Application&quot;</span><span class="p">):</span>
    <span class="n">PORT_LIST_CODES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ue_mode</span><span class="o">=</span><span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;No phone detected&quot;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Download&quot;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;Diagnostic&quot;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;Offline and diagnostic&quot;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;Streaming download&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">API_ATTR_MAP</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ue_model_number</span><span class="o">=</span><span class="s2">&quot;ModelNumber&quot;</span><span class="p">,</span>
        <span class="n">ue_mode</span><span class="o">=</span><span class="s2">&quot;PhoneMode&quot;</span><span class="p">,</span>
        <span class="n">ue_imei</span><span class="o">=</span><span class="s2">&quot;IMEI&quot;</span><span class="p">,</span>
        <span class="n">ue_esn</span><span class="o">=</span><span class="s2">&quot;ESN&quot;</span><span class="p">,</span>
        <span class="n">ue_build_id</span><span class="o">=</span><span class="s2">&quot;BuildId&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># have to do this for every method we want to call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">_FlagAsMethod</span><span class="p">(</span><span class="s2">&quot;AddPort&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">_FlagAsMethod</span><span class="p">(</span><span class="s2">&quot;RemovePort&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">_FlagAsMethod</span><span class="p">(</span><span class="s2">&quot;GetPort&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">HideWindow</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">Quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;enables the specified port in QPST&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">AddPort</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Python generated port&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">GetPortList</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">port_list</span><span class="o">.</span><span class="n">PhoneCount</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">port_list</span><span class="o">.</span><span class="n">PortName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">port_list</span><span class="o">.</span><span class="n">PhoneStatus</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qpst detected no phone on COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">api_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_ATTR_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">port_list</span><span class="p">,</span> <span class="n">api_name</span><span class="p">)</span>
                            <span class="n">port_code</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                            <span class="c1"># Remap codes into strings</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PORT_LIST_CODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="n">port_code</span><span class="p">,</span> <span class="n">port_code</span>
                            <span class="p">)</span>
                            <span class="n">ret</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qpst timeout adding port COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qpst connection failure on COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">remove_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;removes the port from QPST for consistency&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">RemovePort</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">GetPortList</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">port_list</span><span class="o">.</span><span class="n">PhoneCount</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">port_list</span><span class="o">.</span><span class="n">PortName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QXDM disconnect timeout on COM</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="QXDM"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM">[docs]</a><span class="k">class</span> <span class="nc">QXDM</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Win32ComDevice</span><span class="p">,</span> <span class="n">com_object</span><span class="o">=</span><span class="s2">&quot;QXDM.QXDMAutoApplication&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;QXDM software wrapper&quot;&quot;&quot;</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;serial port number for the handset connection&quot;</span><span class="p">)</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;directory for auto-saved isf files&quot;</span><span class="p">)</span>
    <span class="n">connection_timeout</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;connection timeout (s)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="QXDM.open"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_killall</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span> <span class="o">=</span> <span class="n">QPST</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">GetAutomationWindow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Disable to prevent undesired data streaming on startup</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_com_port</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;could not disable UE; does QXDM work if you start it manually?&quot;</span>
            <span class="p">)</span></div>

    <span class="c1"># State traits implemented by command key</span>
    <span class="n">ue_model_number</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;model number code&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ue_model_number&quot;</span><span class="p">)</span>
    <span class="n">ue_mode</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;current state of the phone&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ue_mode&quot;</span><span class="p">)</span>
    <span class="n">ue_imei</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Phone IMEI&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ue_imei&quot;</span><span class="p">)</span>
    <span class="n">ue_esn</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Phone ESN&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ue_esn&quot;</span><span class="p">)</span>
    <span class="n">ue_build_id</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Build ID of software on the phone&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ue_build_id&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="QXDM.get_key"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.get_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">trait_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">DeviceStateError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no state information for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QXDM.close"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">disconnect</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;QPST already quit&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">QuitApplication</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;QXDM already quit&quot;</span><span class="p">)</span>

        <span class="n">lb</span><span class="o">.</span><span class="n">concurrently</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span></div>

<div class="viewcode-block" id="QXDM.configure"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">,</span> <span class="n">min_acquisition_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the QXDM .dmc configuration file at the specified path,</span>
<span class="sd">        with adjustments that disable special file output modes like</span>
<span class="sd">        autosave, quicksave, and automatic segmenting based on time and</span>
<span class="sd">        file size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;config_path </span><span class="si">{}</span><span class="s2"> does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">config_path</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_acquisition_time</span> <span class="o">=</span> <span class="n">min_acquisition_time</span>

        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">config_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-live.dmc&quot;</span>
        <span class="n">path_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Persistence&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MainFrame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ISFSettings&quot;</span><span class="p">)</span>

        <span class="c1"># Disable automatic file saving and partitioning</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;AutoISFSave&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QuickISFSave&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QueryISFSave&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="c1"># These seem to be irrelevant now</span>
        <span class="c1">#        settings.find(&#39;BaseISFName&#39;).text = self.save_base_name</span>
        <span class="c1">#        settings.find(&#39;ISFFolder&#39;).text = self.cache_path</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MaxISFSize&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>  <span class="c1"># str(self.save_size_limit_MB)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MaxISFDuration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MaxISFDurationFraction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>  <span class="c1"># str(self.save_time_limit)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Advanced&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

        <span class="c1"># Don&#39;t care about this any more?</span>
        <span class="c1">#        isv_config = root.find(&#39;Persistence&#39;).find(&#39;LoggingView&#39;).find(&#39;ISVConfig&#39;)</span>
        <span class="c1">#        isv_config.find(&#39;LogFilePath&#39;).text = self.cache_path</span>

        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_config</span><span class="p">(</span><span class="n">path_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loaded modified configuration at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">path_out</span><span class="p">)))</span></div>

<div class="viewcode-block" id="QXDM.save"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saveNm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the run and save the data in a file at the specified path.</span>
<span class="sd">        If path is None, autogenerate with self.cache_path and</span>
<span class="sd">        self.data_filename.</span>

<span class="sd">        This method is threadsafe.</span>

<span class="sd">        :returns: The absolute path to the data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;call start() to acquire data before calling save()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_acquisition_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>
            <span class="k">if</span> <span class="n">t_elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_acquisition_time</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_acquisition_time</span> <span class="o">-</span> <span class="n">t_elapsed</span><span class="p">)</span>
        <span class="c1"># Munge path</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Host</span><span class="o">.</span><span class="n">time_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">),</span> <span class="n">now</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">saveNm</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.isf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">saveNm</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s2">&quot;qxdm-</span><span class="si">{}</span><span class="s2">.isf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Stop acquisition</span>
        <span class="k">with</span> <span class="n">lb</span><span class="o">.</span><span class="n">stopwatch</span><span class="p">(</span><span class="s2">&quot;saving data&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_com_port</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_stop</span><span class="p">()</span>

            <span class="c1"># Save the file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">SaveItemStore</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saved to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="QXDM.start"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start acquisition, optionally waiting to return until</span>
<span class="sd">        new data enters the QXDM item store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_com_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;running after setup for </span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    <span class="c1"># Bare wrapper methods for the low level QXDM COM API</span>
<div class="viewcode-block" id="QXDM._get_com_port"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._get_com_port">[docs]</a>    <span class="k">def</span> <span class="nf">_get_com_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">getCOMPort</span><span class="p">()</span></div>

<div class="viewcode-block" id="QXDM._load_config"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._load_config">[docs]</a>    <span class="k">def</span> <span class="nf">_load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">LoadConfig</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="nd">@lb</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">sets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;QXDM application version&quot;&quot;&quot;</span>
        <span class="n">_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">GetAutomationWindow</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">DeviceNotReady</span><span class="p">(</span><span class="s2">&quot;need to connect to get application version&quot;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">_window</span><span class="o">.</span><span class="n">AppVersion</span>
        <span class="k">return</span> <span class="n">version</span>

<div class="viewcode-block" id="QXDM._get_server_state"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._get_server_state">[docs]</a>    <span class="k">def</span> <span class="nf">_get_server_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">GetServerState</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;server state is in error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></div>

<div class="viewcode-block" id="QXDM._get_item_count"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._get_item_count">[docs]</a>    <span class="k">def</span> <span class="nf">_get_item_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">GetItemCount</span><span class="p">()</span></div>

<div class="viewcode-block" id="QXDM._killall"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._killall">[docs]</a>    <span class="k">def</span> <span class="nf">_killall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;kills all instances of qpst, qxdm, and atmnserver&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">pids</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="s2">&quot;qpst&quot;</span><span class="p">,</span> <span class="s2">&quot;qxdm&quot;</span><span class="p">,</span> <span class="s2">&quot;atmnserver&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;killing zombie process </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                        <span class="p">)</span>
                        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="QXDM._set_com_port"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._set_com_port">[docs]</a>    <span class="k">def</span> <span class="nf">_set_com_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">com_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connects to the handset at the specified serial port.</span>

<span class="sd">        Blocks until QXDM confirms the phone is connected.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            com_port (int): serial port number, COMn; 0 or None to disable</span>

<span class="sd">        Raises:</span>
<span class="sd">            TimeoutError: after waiting `self.connection_timeout` for connection</span>
<span class="sd">            IOError: when the QXDM COM API returns code -1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">com_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">com_port</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">com_port</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_timeout</span><span class="p">):</span>
                <span class="c1"># try it</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">setCOMPort</span><span class="p">(</span><span class="n">com_port</span><span class="p">))</span>

                <span class="c1"># validate</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Connection error&quot;</span><span class="p">)</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_com_port</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">com_port</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">GetServerState</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection error&quot;</span><span class="p">)</span>
                    <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">com_port</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;handset connect to port </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> timed out&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;handset disconnect to port </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> timed out&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">com_port</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect to port </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> took </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;disconnect from port </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> took </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">com_port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_qpst</span><span class="o">.</span><span class="n">remove_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span></div>

<div class="viewcode-block" id="QXDM.reconnect"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reinitializing&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span></div>

<div class="viewcode-block" id="QXDM._clear"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._clear">[docs]</a>    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;clears the buffer of data.</span>

<span class="sd">        TODO: Depending on if QXDM is already running, wait for the item</span>
<span class="sd">        count store to start increasing again?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="s2">&quot;Item view&quot;</span><span class="p">,</span> <span class="s2">&quot;Filtered view&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">ClearViewItems</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;Item view&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed to clear view &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

        <span class="c1"># Block until the item store is clear or timeout</span>
        <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;QXDM item store clear timed out with </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> items&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cleared item store buffer in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QXDM._wait_for_stop"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._wait_for_stop">[docs]</a>    <span class="k">def</span> <span class="nf">_wait_for_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;blocks until the QXDM item store stops growing&quot;&quot;&quot;</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for qxdm to buffer data&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QXDM._wait_for_start"><a class="viewcode-back" href="../../../autoapi/ssmdevices/software/qxdm/index.html#ssmdevices.software.QXDM._wait_for_start">[docs]</a>    <span class="k">def</span> <span class="nf">_wait_for_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_rows</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;blocks until the item store has grown by at least `min_rows`&quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">lb</span><span class="o">.</span><span class="n">timeout_iter</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_count</span><span class="p">()</span> <span class="o">!=</span> <span class="n">start</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;timeout waiting for qxdm to start acquisition&quot;</span><span class="p">)</span>
        <span class="c1">#        lb.sleep(1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;item store grew after </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div></div>

    <span class="c1"># Deprecated</span>


<span class="c1">#    def fetch(self):</span>
<span class="c1">#        time_elapsed = time.time() - self._start_time</span>
<span class="c1">#        if time_elapsed &lt; self.min_acquisition_time:</span>
<span class="c1">#            lb.sleep(self.min_acquisition_time - time_elapsed)</span>
<span class="c1">#</span>
<span class="c1">#        self.stop()</span>
<span class="c1">##        lb.sleep(1)</span>
<span class="c1">#</span>
<span class="c1">#        # Quitting the application should force QXDM to write a &quot;temporary&quot; .isf file containing</span>
<span class="c1">#        # whatever hasn&#39;t already been saved.  This needs to be renamed with the .isf base name.</span>
<span class="c1">#        path = self.renameLatestISF(&#39;99-Final&#39;, self.max_cleanup_tries)</span>
<span class="c1">##        self.clear_stale_isf(path)</span>
<span class="c1">#        return path</span>
<span class="c1">#    def _list_isf(self):</span>
<span class="c1">#        return [e for e in os.listdir(self.cache_path)\</span>
<span class="c1">#                if e.lower().endswith(&#39;.isf&#39;)]</span>
<span class="c1">#</span>

<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#    import labbench as lb</span>
<span class="c1">#</span>
<span class="c1">#    lb.show_messages(&#39;debug&#39;)</span>
<span class="c1">#</span>
<span class="c1">#    # Connect to application</span>
<span class="c1">#    with QXDM(8, cache_path=r&#39;C:\Python Code\potato&#39;, concurrency=False) as qxdm:</span>
<span class="c1">##        mod = inspect.getmodule(qxdm.backend._FlagAsMethod).__name__</span>
<span class="c1">#        print(repr(qxdm.backend),dir(qxdm.backend))</span>
<span class="c1">#        qxdm.configure(r&#39;C:\Python Code\potato\180201_QXDMConfig.dmc&#39;)</span>
<span class="c1">#        for i in range(1):</span>
<span class="c1">#            qxdm.start()</span>
<span class="c1">#            lb.sleep(10)</span>
<span class="c1">#            qxdm.save(r&#39;C:\python code\potato\junk-{}.isf&#39;.format(i))</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.software.qxdm</a></li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>