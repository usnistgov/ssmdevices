<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ssmdevices.instruments.networking &#8212; ssmdevices v0.11</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="ssmdevices v0.11">
  <link rel="canonical" href="../../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../..//static/NISTStyle.css">
  <link rel="stylesheet" href="../../..//static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.instruments.networking</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ssmdevices.instruments.networking</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot; Network test instruments</span>

<span class="sd">Authors:</span>
<span class="sd">    Aziz Kord</span>
<span class="sd">    Dan Kuester</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">labbench</span> <span class="k">as</span> <span class="nn">lb</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AeroflexTM500&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TM500Error</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">errcode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TM500Error</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errcode</span> <span class="o">=</span> <span class="n">errcode</span>


<div class="viewcode-block" id="AeroflexTM500"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500">[docs]</a><span class="k">class</span> <span class="nc">AeroflexTM500</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">TelnetDevice</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Control an Aeroflex TM500 network tester with a</span>
<span class="sd">    telnet connection.</span>

<span class="sd">    The approach here is to iterate through lines of bytes, and</span>
<span class="sd">    add delays as needed for special cases as defined in the</span>
<span class="sd">    `delays` attribute.</span>

<span class="sd">    At some point, these lines should just be loaded directly</span>
<span class="sd">    from a file that could be treated as a config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">timeout</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;leave the timeout small to allow keyboard interrupts&quot;</span>
    <span class="p">)</span>
    <span class="n">ack_timeout</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
        <span class="mi">30</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;how long to wait for a command acknowledgment from the TM500 (s)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">busy_retries</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">remote_ip</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;10.133.0.203&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ip address of TM500 backend&quot;</span><span class="p">)</span>
    <span class="n">remote_ports</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;5001 5002 5003&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;port of TM500 backend&quot;</span><span class="p">)</span>
    <span class="n">min_acquisition_time</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="mi">30</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;minimum time to spend acquiring logs (s)&quot;</span>
    <span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">5003</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">config_root</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to the command scripts directory&quot;</span><span class="p">)</span>
    <span class="n">data_root</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;remote save root directory&quot;</span><span class="p">)</span>
    <span class="n">convert_files</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
        <span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;text to match in the filename of data output files to convert&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="AeroflexTM500.arm"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.arm">[docs]</a>    <span class="k">def</span> <span class="nf">arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the scenario from the command listing in a local TM500</span>
<span class="sd">        configuration file.</span>
<span class="sd">        The the full path to the configuration file is</span>
<span class="sd">        `os.path.join(self.config_root, self.config_file)+&#39;.conf&#39;`</span>
<span class="sd">        (on the host computer running this python instance).</span>

<span class="sd">        If the last script that was run is the same as the selected config</span>
<span class="sd">        script, then the script is loaded and sent to the TM500 only</span>
<span class="sd">        if force=True. It always runs on the first call after AeroflexTM500</span>
<span class="sd">        is instantiated.</span>

<span class="sd">        :returns: A list of responses to each command sent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">scenario_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scenario_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;scenario_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TM500Error</span><span class="p">(</span>
                <span class="s2">&quot;the TM500 is already armed with the scenario named </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">scenario_name</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_root</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.conf&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;arming TM500 scenario </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">config_path</span><span class="p">)))</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;#$$DATA_LOG_FOLDER 1 &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_root</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;armed in </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;scenario_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_name</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="AeroflexTM500.trigger"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start logging and return the path to the directory where the data</span>
<span class="sd">        is being saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scenario_name&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TM500Error</span><span class="p">(</span><span class="s2">&quot;arm before triggering&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$START_LOGGING&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;trigger_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AeroflexTM500.stop"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop logging.</span>
<span class="sd">        :param bool convert: Whether to convert the output binary files to text</span>

<span class="sd">        :returns: If convert=True, a dictionary of {&#39;name&#39;: path} items pointing to the converted text output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">convert</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_until_min_acquisition</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Stop running</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;forw mte MtsClearMts&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;WAIT FOR &quot;I: CMPI MTE 0 MTSCLEARMTS COMPLETE IND&quot; TIMEOUT 60&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;forw mte DeConfigRdaStopTestCase&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;WAIT FOR &quot;I: CMPI DTE RDA TEST GROUP STOPPED IND&quot; TIMEOUT 300&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TM500Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;exception on attempt to stop scenario: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;there is no active logging to stop&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$STOP_LOGGING&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_text</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;forw mte GetRrcStats [] [] [] [1] [1]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;forw mte GetNasStats [] [] [] [] [1] [1]&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span>
                <span class="s2">&quot;SDLI LTE_RADIO_CONTEXT 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span>
                <span class="s2">&quot;SDLI LTE_NAS_STATUS 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span>
                <span class="s2">&quot;SDLI LTE_RRC_STATUS 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">TM500Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;exception on attempt to cleanup scenario: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;scenario_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;trigger_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="AeroflexTM500.reboot"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reboot the TMA and TM500 hardware.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;RBOT&quot;</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">TelnetDevice</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">TelnetDevice</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;timeout reconnecting to the tm500 after reboot&quot;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">read_very_eager</span><span class="p">()</span>

            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;I: REBOOT - The Test Mobile has rebooted&quot;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;no message confirming reboot&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;tm500 rebooted after </span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span></div>

<div class="viewcode-block" id="AeroflexTM500.command_log_to_script"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.command_log_to_script">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">command_log_to_script</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scrape a script out of a TM500 &quot;screen save&quot; text file. The output</span>
<span class="sd">        for an input that takes the form &lt;path&gt;/&lt;to&gt;/&lt;filename&gt;.txt</span>
<span class="sd">        will be &lt;path&gt;/&lt;to&gt;/&lt;filename&gt;-script.txt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># Remove the timestamp.</span>
        <span class="c1"># Assumes tab-delimiter separtaes timestamps from the telnet traffic.</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>

        <span class="c1"># start where things get interesting</span>
        <span class="c1">#        i = txt.lower().find(b&#39;abot 0 0 0&#39;)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;rset&quot;</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no start delimited by RSET command found in command log&quot;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>

        <span class="c1"># end at activate</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;C: FORW 0X00 OK MTE ACTIVATE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no activate found in command log&quot;</span><span class="p">)</span>
        <span class="n">i_eol</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_eol</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">i_eol</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

        <span class="n">blocks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(^C: .*)&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

        <span class="c1"># Throw out odd-numbered leftover at the end</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[:</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># The result is organized by pairs of (big chunk of data, command response).</span>
        <span class="c1"># Get the command from the first word of the incoming command</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Get the 2nd field in the response field. That&#39;s the start of command</span>
            <span class="c1"># the full line command.</span>
            <span class="n">rsp</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">WARNING: Don&#39;t know what to do with command response &quot;</span><span class="p">,</span>
                    <span class="n">blocks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="c1"># Find the line that starts with the line in the previous block of</span>
            <span class="c1"># text. Throw a warning unless there was exactly 1 match in the</span>
            <span class="c1"># block of text.</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                <span class="sa">rb</span><span class="s2">&quot;^([\#\$]*&quot;</span> <span class="o">+</span> <span class="n">cmd</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;.*)&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">WARNING: Found no command for &quot;</span><span class="p">,</span>
                    <span class="n">blocks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> after &quot;</span><span class="p">,</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">WARNING: More than one match for &quot;</span><span class="p">,</span>
                    <span class="n">blocks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s2">&quot;: &quot;</span><span class="p">,</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;START_LOGGING&quot;</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.conf&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">))</span></div>

<div class="viewcode-block" id="AeroflexTM500.close"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scenario_name&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TM500Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">):</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$DISCONNECT&quot;</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="AeroflexTM500.open"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Invalidate any incomplete previous commands in the remote telnet buffer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;***&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$DISCONNECT&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Set up licensing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;ABOT 0 0 0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;SCFG SWL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;STRT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;forw swl setlicenseserver none&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AeroflexTM500._tma_is_connected"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._tma_is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">_tma_is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;CHOW&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TM500Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errcode</span> <span class="ow">in</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AeroflexTM500._reconnect"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure the TMA software is connected to the TM500&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tma_is_connected</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Now connect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span>
                <span class="s2">&quot;#$$PORT </span><span class="si">{ip}</span><span class="s2"> </span><span class="si">{ports}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_ports</span>
                <span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$CONNECT&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AeroflexTM500._block_until_min_acquisition"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._block_until_min_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">_block_until_min_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure the minimum acquisition time has elapsed to avoid putting</span>
<span class="sd">        the TM500 in a sad state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trigger_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trigger_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_acquisition_time</span><span class="p">:</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_acquisition_time</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span></div>

<div class="viewcode-block" id="AeroflexTM500._send"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._send">[docs]</a>    <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data_lines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a message, then block until a confirmation message is received.</span>

<span class="sd">        :param msg: str or bytes containing the message to send</span>
<span class="sd">        :param int data_lines: number of lines in the response string</span>

<span class="sd">        :returns: decoded string containing the response</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First, if this is a sequence of messages, work through them one by one</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">]</span>

        <span class="c1"># Send the message</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;wait for&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="sa">b</span><span class="s2">&quot;timeout&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;write </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Figure out the expected response</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rsp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;#$$&quot;</span><span class="p">):</span>
            <span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;C: &quot;</span> <span class="o">+</span> <span class="n">rsp</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; &quot;</span>

        <span class="c1"># Block until the response</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_until</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

            <span class="c1"># Receive through the end of line for the rest of the status response</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">rsp</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_lines</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;0x&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TM500Error</span><span class="p">(</span>
                        <span class="s2">&quot;Error in message </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ret</span><span class="p">)),</span> <span class="n">code</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                <span class="s2">&quot;timeout waiting for response to command </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># Receive any other data received during the delay</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">read_very_eager</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extra</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extra -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extra -&gt; (</span><span class="si">{}</span><span class="s2"> lines)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AeroflexTM500._convert_to_text"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._convert_to_text">[docs]</a>    <span class="k">def</span> <span class="nf">_convert_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the latest data to text&quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__latest</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># TODO Is this really necessary?</span>

        <span class="c1">#            pre_entries = [f for f in os.listdir(root)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s2">&quot;#$$CONVERT_TO_TEXT&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">))]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">paths</span><span class="p">))</span>

        <span class="c1"># Remove items not listed in self.convert_files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">inc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ret</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;converted TM500 logs from binary in </span><span class="si">{:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="AeroflexTM500._read_until"><a class="viewcode-back" href="../../../autoapi/ssmdevices/instruments/networking/index.html#ssmdevices.instruments.AeroflexTM500._read_until">[docs]</a>    <span class="k">def</span> <span class="nf">_read_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ack_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ack_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ack_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="c1">#        self._logger.debug(&#39;awaiting response {}&#39;.format(repr(rsp)))</span>

        <span class="c1"># Block until the expected response is received</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">ack_timeout</span><span class="p">:</span>
            <span class="c1"># Looping on short blocking makes it easier to</span>
            <span class="c1"># cancel execution with a KeyboardInterrupt</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">ack_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rsp</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;response timeout&quot;</span><span class="p">)</span>
        <span class="c1">#        self._logger.debug(&#39;    -&gt; {}&#39;.format(ret))</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">labbench</span> <span class="k">as</span> <span class="nn">lb</span>

    <span class="c1"># AeroflexTM500.key_log_to_script(r&#39;C:\Users\dkuester\Desktop\TM500_2Sec_8UEs_withTime.txt&#39;)</span>

<span class="c1">#    path = r&#39;e:\TM500ScriptForPaulDebug&#39;</span>
<span class="c1">#    lb.show_messages(&#39;debug&#39;)</span>
<span class="c1">#    tm500 = AeroflexTM500(&#39;10.133.0.202&#39;)</span>
<span class="c1">#    with tm500:</span>
<span class="c1">##    tm500.open()</span>
<span class="c1">#        t0 = time.time()</span>
<span class="c1">#        tm500.configure(path)</span>
<span class="c1">#        print(time.time()-t0)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../ssmdevices.html">ssmdevices v0.11</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ssmdevices.instruments.networking</a></li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>