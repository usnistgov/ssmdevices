
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ssmdevices.software.network_profiling &#8212; ssmdevices 0.6 documentation</title>
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../index.html">
          <span>ssmdevices 0.6 documentation</span></a></h1>
        <h2 class="heading"><span>ssmdevices.software.network_profiling</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../ssmdevices.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for ssmdevices.software.network_profiling</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Dan Kuester &lt;daniel.kuester@nist.gov&gt;,</span>
<span class="sd">         Michael Voecks &lt;michael.voecks@nist.gov&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">future</span> <span class="k">import</span> <span class="n">standard_library</span>
<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">super</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IPerfClient&#39;</span><span class="p">,</span><span class="s1">&#39;IPerf&#39;</span><span class="p">,</span><span class="s1">&#39;IPerfOnAndroid&#39;</span><span class="p">,</span> <span class="s1">&#39;IPerfBoundPair&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ClosedLoopNetworkingTest&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">labbench</span> <span class="k">as</span> <span class="nn">lb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssmdevices.lib</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>



<div class="viewcode-block" id="IPerf"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerf">[docs]</a><span class="k">class</span> <span class="nc">IPerf</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">CommandLineWrapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Run an instance of iperf, collecting output data in a background thread.</span>
<span class="sd">        When running as an iperf client (server=False), </span>
<span class="sd">        The default value is the path that installs with 64-bit cygwin.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
<div class="viewcode-block" id="IPerf.settings"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerf.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">CommandLineWrapper</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">binary_path</span>   <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;iperf.exe&#39;</span><span class="p">))</span>
        <span class="n">timeout</span>       <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;wait time for traffic results before throwing a timeout exception (s)&#39;</span><span class="p">)</span>
        <span class="n">port</span>          <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">5001</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;connection port&#39;</span><span class="p">)</span>
        <span class="n">bind</span>          <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-B&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;bind connection to specified IP&#39;</span><span class="p">)</span>
        <span class="n">tcp_window_size</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;(bytes)&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">buffer_size</span>   <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Size of data buffer that generates traffic (bytes)&#39;</span><span class="p">)</span>
        <span class="n">interval</span>      <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Interval between throughput reports (s)&#39;</span><span class="p">)</span>
        <span class="n">bidirectional</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Send and receive simultaneously&#39;</span><span class="p">)</span>
        <span class="n">udp</span>           <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use UDP instead of the default, TCP&#39;</span><span class="p">)</span>
        <span class="n">bit_rate</span>      <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum bit rate (append unit for size, e.g. 10K)&#39;</span><span class="p">)</span>
        <span class="n">time</span>          <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">16535</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;time in seconds to transmit before quitting (default 10s)&#39;</span><span class="p">)</span>
        <span class="n">arguments</span>     <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">,</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf.fetch"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerf.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Retreive csv-formatted text from standard output and parse into</span>
<span class="sd">            a pandas DataFrame.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">()</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span><span class="s1">&#39;source_address&#39;</span><span class="p">,</span>\
                  <span class="s1">&#39;source_port&#39;</span><span class="p">,</span><span class="s1">&#39;destination_address&#39;</span><span class="p">,</span><span class="s1">&#39;destination_port&#39;</span><span class="p">,</span>\
                  <span class="s1">&#39;test_id&#39;</span><span class="p">,</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span><span class="s1">&#39;transferred_bytes&#39;</span><span class="p">,</span><span class="s1">&#39;bits_per_second&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;jitter_milliseconds&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;datagrams_lost&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;datagrams_sent&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;datagrams_loss_percentage&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;datagrams_out_of_order&#39;</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iperf_&#39;</span><span class="o">+</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="c1"># throw out the last row (potantially a summary of the previous rows)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;iperf_interval&#39;</span><span class="p">,</span><span class="s1">&#39;iperf_transferred_bytes&#39;</span><span class="p">,</span><span class="s1">&#39;iperf_test_id&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;iperf_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iperf_timestamp&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;iperf_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;iperf_timestamp&#39;</span><span class="p">]</span><span class="o">+</span>\
                                  <span class="n">pd</span><span class="o">.</span><span class="n">TimedeltaIndex</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="IPerf.background"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerf.background">[docs]</a>    <span class="k">def</span> <span class="nf">background</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_args</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">buffer_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;iperf might not behave nicely setting udp=True with buffer_size&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">bit_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;iperf does not support setting bit_rate in TCP&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">respawn</span><span class="p">:</span><span class="c1">#, self.exception_on_stderr:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">IPerf</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">),</span> <span class="o">*</span><span class="n">extra_args</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">IPerf</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_args</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerf.start"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerf.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">()</span></div></div>

<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>

<div class="viewcode-block" id="IPerfOnAndroid"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid">[docs]</a><span class="k">class</span> <span class="nc">IPerfOnAndroid</span><span class="p">(</span><span class="n">IPerf</span><span class="p">):</span>
    <span class="n">remote_binary_path</span> <span class="o">=</span> <span class="s1">&#39;/data/local/tmp/iperf&#39;</span>

<div class="viewcode-block" id="IPerfOnAndroid.settings"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">IPerf</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">binary_path</span>        <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;adb.exe&#39;</span><span class="p">))</span>
        <span class="n">remote_binary_path</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;/data/local/tmp/iperf&#39;</span><span class="p">,</span>
                                             <span class="p">)</span>
        <span class="n">arguments</span>          <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">remote_binary_path</span><span class="o">.</span><span class="n">default_value</span><span class="p">,</span>
                                     <span class="c1"># &#39;-y&#39;, &#39;C&#39;</span>
                                          <span class="p">])</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.connect"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_state_arguments</span><span class="p">:</span>
<span class="c1">#            self.logger.warning(&#39;TODO: need to fix setup for android iperf, but ok for now&#39;)</span>
<span class="c1">#            devices = self.foreground(&#39;devices&#39;).strip().rstrip().splitlines()[1:]</span>
<span class="c1">#            if len(devices) == 0:</span>
<span class="c1">#                raise Exception(&#39;adb lists no devices. is the UE connected?&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;waiting for USB connection to phone&#39;</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;wait-for-device&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;copying iperf onto phone&#39;</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="n">ssmdevices</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;android&#39;</span><span class="p">,</span><span class="s1">&#39;iperf&#39;</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;wait-for-device&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="s1">&#39;777&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;wait-for-device&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
<span class="c1">#            # Check that it&#39;s executable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;verifying iperf execution on phone&#39;</span><span class="p">)</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;shell&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_binary_path</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">],</span>
                         <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/system/bin/sh&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;could not execute!!! &#39;</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;phone is ready to execute iperf&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.start"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPerfOnAndroid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>        
        <span class="k">if</span> <span class="s1">&#39;network&#39;</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no network connectivity in UE&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.kill"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Kill the local process and the iperf process on the UE.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Kill the local adb process as normal</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPerfOnAndroid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

        <span class="c1"># Now&#39;s where the fun really starts</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_state_arguments</span><span class="p">:</span>
            <span class="c1"># Find and kill processes on the UE</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreground</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_binary_path</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;killing zombie iperf. stdout: </span><span class="si">{}</span><span class="s1">&#39;</span>\
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreground</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;-9&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)))</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Wait for any iperf zombie processes to die</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="n">wait_time</span> <span class="ow">and</span> <span class="n">wait_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreground</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;iperf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">25</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;timeout waiting for iperf process termination on UE&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.read_stdout"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; adb seems to forward stderr as stdout. Filter out some undesired</span>
<span class="sd">            resulting status messages.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IPerfOnAndroid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;stdout: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="IPerfOnAndroid.fetch"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.wait_for_cell_data"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.wait_for_cell_data">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_cell_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Block until cellular data is available</span>

<span class="sd">        :param timeout: how long to wait for a connection before raising a Timeout error</span>
<span class="sd">        :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
        <span class="kn">import</span> <span class="nn">re</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;waiting for cellular data connection&#39;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;dumpsys&#39;</span><span class="p">,</span> <span class="s1">&#39;telephony.registry&#39;</span><span class="p">],</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

            <span class="n">con</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;mDataConnectionState=([\-0-9]+)&#39;</span><span class="p">,</span>
                             <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">con</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;phone did not connect for cellular data before timeout&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cellular data available after </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.reboot"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Reboot the device.</span>

<span class="sd">        :param block: if this evaluates to True, block until the device is ready to accept commands</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;reboot&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerfOnAndroid.wait"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfOnAndroid.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Block until the device is ready to accept commands</span>

<span class="sd">        :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,</span> <span class="s1">&#39;wait-for-device&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;device is ready&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="IPerfClient"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfClient">[docs]</a><span class="k">class</span> <span class="nc">IPerfClient</span><span class="p">(</span><span class="n">IPerf</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This class is deprected. Use IPerf instead</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__imports__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;this class is deprecated! use </span><span class="si">{}</span><span class="s1"> instead&#39;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">IPerf</span><span class="p">)))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPerfClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__imports__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>


<div class="viewcode-block" id="IPerfBoundPair"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair">[docs]</a><span class="k">class</span> <span class="nc">IPerfBoundPair</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Run an iperf client and a server on the host computer at the same time. They are</span>
<span class="sd">        bound to opposite interfaces to ensure data is routed between them, and not through</span>
<span class="sd">        localhost or any other interface.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Copy the IPerf settings. Most of these are simply passed through </span>
<div class="viewcode-block" id="IPerfBoundPair.settings"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">IPerf</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;ignored - use sender and receiver instead&#39;</span><span class="p">)</span>
        <span class="n">bind</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># blanked out - determined for the client and server based on sender and receiver addresses</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;the ip address to use for the iperf client, which must match a network interface on the host&#39;</span><span class="p">)</span>
        <span class="n">receiver</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;the ip address to use for the iperf server, which must match a network interface on the host&#39;</span><span class="p">)</span>
        <span class="n">port_max</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">6000</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s1">&#39;highest port number to use when cycling through ports&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPerfBoundPair.state"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.state">[docs]</a>    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span>

<div class="viewcode-block" id="IPerfBoundPair.connect"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">read_only</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">,</span> <span class="s1">&#39;receiver&#39;</span><span class="p">,</span> <span class="s1">&#39;bind&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">IPerf</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                       <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">IPerf</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        
        <span class="n">server</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">:</span> <span class="n">client</span><span class="p">,</span> <span class="s1">&#39;iperf_server&#39;</span><span class="p">:</span> <span class="n">server</span><span class="p">}</span></div>
        
<div class="viewcode-block" id="IPerfBoundPair.disconnect"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;NoneType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="IPerfBoundPair.kill"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerfBoundPair.running"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.running">[docs]</a>    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">running</span><span class="p">()</span>\
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">running</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPerfBoundPair.fetch"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">:</span> <span class="n">client</span><span class="p">,</span>
                <span class="s1">&#39;iperf_server&#39;</span><span class="p">:</span> <span class="n">server</span><span class="p">}</span></div>

<div class="viewcode-block" id="IPerfBoundPair.start"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Increment the port, because binding seems to cause blockin in win32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port_max</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_start</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="IPerfBoundPair.acquire"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.IPerfBoundPair.acquire">[docs]</a>    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Acquire iperf output for the specified duration and return.</span>
<span class="sd">            Raises a lb.DeviceConnectionLost if iperf stops before the</span>
<span class="sd">            duration has finished.</span>
<span class="sd">            </span>
<span class="sd">            Call run before </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
            <span class="c1"># Blank any buffered output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Wait for the duration, checking regularly to ensure the client is running</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">duration</span><span class="o">-</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">DeviceConnectionLost</span><span class="p">(</span><span class="s1">&#39;iperf stopped unexpectedly&#39;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  iperf_client and server returned </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> rows&#39;</span>\
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;iperf_client&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;iperf_server&#39;</span><span class="p">])))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<span class="n">m1</span>  <span class="o">=</span> <span class="mh">0x5555555555555555</span>
<span class="n">m2</span>  <span class="o">=</span> <span class="mh">0x3333333333333333</span>
<span class="n">m4</span>  <span class="o">=</span> <span class="mh">0x0f0f0f0f0f0f0f0f</span>
<span class="n">m8</span>  <span class="o">=</span> <span class="mh">0x00ff00ff00ff00ff</span>
<span class="n">m16</span> <span class="o">=</span> <span class="mh">0x0000ffff0000ffff</span>
<span class="n">m32</span> <span class="o">=</span> <span class="mh">0x00000000ffffffff</span>
<span class="n">h01</span> <span class="o">=</span> <span class="mh">0x0101010101010101</span>

<span class="k">def</span> <span class="nf">bit_errors</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; See: https://en.wikipedia.org/wiki/Hamming_weight</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
<span class="c1">#    a1 = np.frombuffer(buf1,dtype=&#39;uint64&#39;)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="p">[:(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m1</span><span class="p">;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">m2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m2</span><span class="p">);</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m4</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">h01</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SocketWorker</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiler</span><span class="p">,</span> <span class="n">except_event</span><span class="p">,</span> <span class="n">tx_ready</span><span class="p">,</span> <span class="n">rx_ready</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">skip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">receiver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">sender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">udp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcp_nodelay</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tcp_nodelay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress</span> <span class="o">=</span> <span class="n">suppress</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span> <span class="o">=</span> <span class="n">except_event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_ready</span> <span class="o">=</span> <span class="n">tx_ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rx_ready</span> <span class="o">=</span> <span class="n">rx_ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span> <span class="o">=</span> <span class="p">[]</span>        

    <span class="k">def</span> <span class="nf">__call__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udp</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcp</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">lb</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.__class__.__name__}</span><span class="s1">() ended by master thread&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.__class__.__name__}</span><span class="s1"> socket timeout on {self.i+1}/</span><span class="si">{count}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;traffic stopped&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sent</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;missed {count-self.i}/</span><span class="si">{count}</span><span class="s1"> datagrams&#39;</span><span class="p">)</span>     
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;failed to recognize {len(self.bad_data)} datagrams&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

<span class="k">class</span> <span class="nc">ReceiveWorker</span><span class="p">(</span><span class="n">SocketWorker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="k">else</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>        
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket_type</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Avoid some already in use errors if we try to reuse the socket</span>
            <span class="c1"># soon after closing it</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># The receive buffer for this socket (under the hood in the OS)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>        
            <span class="n">bufsize</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bufsize</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;recv buffer size is </span><span class="si">{bufsize}</span><span class="s1">, but need at least </span><span class="si">{self.bytes}</span><span class="s1">&#39;</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sock</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Make friends with the sender            </span>
                <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">conn</span><span class="p">,</span> <span class="n">other_addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">other_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;connection request from incorrect ip </span><span class="si">{other_addr[0]}</span><span class="s1">&#39;</span><span class="p">)</span>                    
                <span class="n">conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="n">conn</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__call__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sender_obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sender_obj</span> <span class="o">=</span> <span class="n">sender_obj</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>        
        
    <span class="k">def</span> <span class="nf">_udp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>       
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">count</span>
        <span class="n">finishes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">count</span>
        <span class="n">received</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">count</span>            
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">)</span>
            <span class="c1"># Receive the data</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">+</span><span class="n">count</span><span class="p">):</span>
                <span class="c1"># Bail if the sender hit an exception</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">()</span>
    
                <span class="bp">self</span><span class="o">.</span><span class="n">tx_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    
                <span class="n">started</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    
                <span class="c1"># UDP datagrams seem to come atomically. One simple recv.</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>
                <span class="n">finished</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;udp sender is </span><span class="si">{addr[0]}</span><span class="s2">, but expected </span><span class="si">{self.sender}</span><span class="s2">&quot;</span><span class="p">)</span>
    
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">i_sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_obj</span><span class="o">.</span><span class="n">sent</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c1">#                    if i_sent != self.i:</span>
<span class="c1">#                        print(&#39;index mismatch: &#39;, self.i, i_sent)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                    <span class="n">starts</span><span class="p">[</span><span class="n">i_sent</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">]</span> <span class="o">=</span> <span class="n">started</span>
                    <span class="n">finishes</span><span class="p">[</span><span class="n">i_sent</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">]</span> <span class="o">=</span> <span class="n">finished</span>
                    <span class="n">received</span><span class="p">[</span><span class="n">i_sent</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
                    
        <span class="n">error_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">bit_errors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">received</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;receive_start_timestamp&#39;</span><span class="p">:</span> <span class="n">starts</span><span class="p">,</span>
                <span class="s1">&#39;receive_finish_timestamp&#39;</span><span class="p">:</span> <span class="n">finishes</span><span class="p">,</span>
                <span class="s1">&#39;bit_error_count&#39;</span><span class="p">:</span>  <span class="n">error_count</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_tcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>        
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>            
        <span class="n">starts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">finishes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">received</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="c1"># Receive the data</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">+</span><span class="n">count</span><span class="p">):</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Bail if the sender hit an exception</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">()</span>

                <span class="n">started</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

                <span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">rx_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">:</span>
                    <span class="n">rx_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">rx_count</span><span class="p">:],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="o">-</span><span class="n">rx_count</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">started</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">()</span>

                <span class="n">finished</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="c1"># Throw away the first sample</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                    <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">started</span><span class="p">)</span>
                    <span class="n">finishes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finished</span><span class="p">)</span>
                    <span class="n">received</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
        <span class="n">error_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">bit_errors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">received</span><span class="p">]</span>
                    
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;receive_start_timestamp&#39;</span><span class="p">:</span> <span class="n">starts</span><span class="p">,</span>
                <span class="s1">&#39;receive_finish_timestamp&#39;</span><span class="p">:</span> <span class="n">finishes</span><span class="p">,</span>
                <span class="s1">&#39;bit_error_count&#39;</span><span class="p">:</span>  <span class="n">error_count</span><span class="p">}</span>
        
<span class="k">class</span> <span class="nc">SendWorker</span><span class="p">(</span><span class="n">SocketWorker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="k">else</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>        
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket_type</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The OS-level TCP transmit buffer size for this socket.</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>
            <span class="n">bytes_actual</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bytes_actual</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;send buffer size is </span><span class="si">{bytes_actual}</span><span class="s1">, but requested </span><span class="si">{self.bytes}</span><span class="s1">&#39;</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp_nodelay</span><span class="p">)</span>

            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            
            <span class="k">return</span> <span class="n">sock</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_tcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="c1"># TODO: configure the type of data sent?</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># No point in more interesting data unless the point is to debug TCP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">+</span><span class="n">count</span><span class="p">):</span>
                <span class="c1"># Throw any initial samples as configured</span>
                <span class="c1"># Do this first to make sure there is data to return</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_counter</span><span class="p">())</span>

                <span class="c1"># Leave now if the server bailed</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">()</span>                
    
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s1">&#39;send_timestamp&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
                <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_udp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>                   
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">+</span><span class="n">count</span><span class="p">):</span>
                <span class="c1"># Generate the next data to send</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span> <span class="c1"># b&#39;\x00&#39;*size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sent</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
                
                <span class="c1"># Leave now if the server bailed</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">except_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">lb</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">()</span>                
    
                <span class="c1"># Throw any initial samples as configured</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_counter</span><span class="p">())</span>
    
                <span class="bp">self</span><span class="o">.</span><span class="n">tx_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rx_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    
                <span class="n">lb</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s1">&#39;send_timestamp&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
                <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">}</span>


<div class="viewcode-block" id="ClosedLoopNetworkingTest"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.ClosedLoopNetworkingTest">[docs]</a><span class="k">class</span> <span class="nc">ClosedLoopNetworkingTest</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Profile closed-loop UDP or TCP traffic between two network interfaces</span>
<span class="sd">        on the computer. Takes advantage of the shared clock to provide</span>
<span class="sd">        one-way traffic delay with uncertainty on the order of the system time</span>
<span class="sd">        resolution.</span>
<span class="sd">        </span>
<span class="sd">        WARNING: UDP does not work right yet.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
<div class="viewcode-block" id="ClosedLoopNetworkingTest.settings"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.ClosedLoopNetworkingTest.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;the ip address of the network interface to use to send data&#39;</span><span class="p">)</span>
        <span class="n">receiver</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;the ip address of the network interface to use to receive data&#39;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">5555</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;TCP or UDP port&#39;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;skipd - use sender and receiver instead&#39;</span><span class="p">)</span>        
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;timeout before aborting the test&#39;</span><span class="p">)</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;TCP or UDP transmit data size&#39;</span><span class="p">)</span>
        <span class="n">udp</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use UDP (True) or TCP (False)&#39;</span><span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;extra buffers to send and not log before acquisition&#39;</span><span class="p">)</span>
        <span class="n">tcp_nodelay</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if True, disable Nagle</span><span class="se">\&#39;</span><span class="s1">s algorithm&#39;</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">(sender=&#39;</span><span class="si">{sender}</span><span class="s2">&#39;,receiver=&#39;</span><span class="si">{receiver}</span><span class="s2">&#39;)&quot;</span>\
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                       <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                       <span class="n">receiver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">receiver</span><span class="p">)</span>

<span class="c1">#    @lb.retry((ConnectionError,TimeoutError), 2)</span>
<div class="viewcode-block" id="ClosedLoopNetworkingTest.acquire"><a class="viewcode-back" href="../../../ssmdevices.software.html#ssmdevices.software.network_profiling.ClosedLoopNetworkingTest.acquire">[docs]</a>    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">udp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tcp_nodelay</span>\
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;with tcp_nodelay enabled, set bytes larger than the MTU (1500)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sent</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Parameters for the client and server</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;except_event&#39;</span><span class="p">:</span> <span class="n">Event</span><span class="p">(),</span>
                  <span class="s1">&#39;rx_ready&#39;</span><span class="p">:</span> <span class="n">Event</span><span class="p">(),</span>
                  <span class="s1">&#39;tx_ready&#39;</span><span class="p">:</span> <span class="n">Event</span><span class="p">()}</span>

        <span class="n">receiver</span> <span class="o">=</span> <span class="n">ReceiveWorker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">events</span><span class="p">)</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">SendWorker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">events</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">concurrently</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sender</span><span class="p">),</span>
                              <span class="n">lb</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">sender</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
                              <span class="n">traceback_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s1">&#39;send failed&#39;</span><span class="p">)</span>
            
        <span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">TimedeltaIndex</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">send_timestamp</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;bit_error_count&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">bit_error_count</span><span class="p">,</span>
                            <span class="s1">&#39;bytes_sent&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
                            <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">receive_finish_timestamp</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">receive_start_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">receive_start_timestamp</span><span class="o">-</span><span class="n">ret</span><span class="o">.</span><span class="n">send_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="o">+</span><span class="n">start</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span></div></div>

<span class="c1"># Examples</span>
<span class="c1"># ClosedLoopNetworkingTest example</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pylab</span>
    
    <span class="k">with</span> <span class="n">ClosedLoopNetworkingTest</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="s1">&#39;10.0.0.2&#39;</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="s1">&#39;10.0.0.3&#39;</span><span class="p">,</span>
                                  <span class="nb">bytes</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="k">as</span> <span class="n">net</span><span class="p">:</span>    
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">traffic</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">traffic</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>            
    <span class="c1">#        traffic[[&#39;duration&#39;,&#39;delay&#39;]].plot(marker=&#39;.&#39;, lw=0)</span>
            <span class="n">traffic</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">bytes</span><span class="o">/</span><span class="n">traffic</span><span class="o">.</span><span class="n">duration</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;medians</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">traffic</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1">#if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#    lb.show_messages(&#39;debug&#39;)</span>
<span class="c1">#    ips = IPerf(interval=0.5, udp=True)</span>
<span class="c1">#</span>
<span class="c1">#    ipc = IPerf(&#39;127.0.0.1&#39;,interval=1, time=10000, udp=True, bit_rate=&#39;1M&#39;)</span>
<span class="c1">##    ipc.iperf_path = r&#39;..\lib\iperf.exe&#39;</span>
<span class="c1">#</span>
<span class="c1">#    with ipc,ips:</span>
<span class="c1">#        for i in range(1):</span>
<span class="c1">#            ips.start()</span>
<span class="c1">#            lb.sleep(1)</span>
<span class="c1">#            ipc.start()</span>
<span class="c1">#            lb.sleep(20)</span>
<span class="c1">#            ipc.kill()</span>
<span class="c1">#            ips.kill()</span>
<span class="c1">#            ips_result = ips.read_stdout()</span>
<span class="c1">#            ipc_result = ipc.read_stdout()</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../ssmdevices.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright  does not apply.

This software was developed by employees of the National Institute of Standards and Technology (NIST), an agency of the
Federal Government. Pursuant to title 17 United States Code Section 105, works of NIST employees are not subject to
copyright protection in the United States and are considered to be in the public domain. Permission to freely use, copy,
modify, and distribute this software and its documentation without fee is hereby granted, provided that this notice and
disclaimer of warranty appears in all copies.

THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING,
BUT NOT LIMITED TO, ANY WARRANTY THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM INFRINGEMENT, AND ANY WARRANTY THAT THE
DOCUMENTATION WILL CONFORM TO THE SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT SHALL
NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT, INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES,
ARISING OUT OF, RESULTING FROM, OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON WARRANTY,
CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER
OR NOT LOSS WAS SUSTAINED FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES PROVIDED HEREUNDER.

Distributions of NIST software should also include copyright and licensing statements of any third-party software
that are legally bundled with the code in compliance with the conditions of those licenses..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>