
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>labbench.core &#8212; ssmdevices 0.2 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>ssmdevices 0.2 documentation</span></a></h1>
        <h2 class="heading"><span>labbench.core</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../ssmdevices.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for labbench.core</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">bytes</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ConnectionError&#39;</span><span class="p">,</span> <span class="s1">&#39;RemoteStateError&#39;</span><span class="p">,</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="s1">&#39;Int&#39;</span><span class="p">,</span> <span class="s1">&#39;Float&#39;</span><span class="p">,</span> <span class="s1">&#39;Unicode&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Complex&#39;</span><span class="p">,</span> <span class="s1">&#39;Bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;EnumBytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Bool&#39;</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">,</span>
           <span class="s1">&#39;StateAggregator&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">traitlets</span><span class="o">,</span><span class="nn">inspect</span><span class="o">,</span><span class="nn">numbers</span><span class="o">,</span><span class="nn">copy</span><span class="o">,</span><span class="nn">logging</span><span class="o">,</span><span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">traitlets</span> <span class="k">import</span> <span class="n">All</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span><span class="n">TraitType</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;labbench&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectionError</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RemoteStateError</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">CommandNotImplementedError</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RemoteTraitMixIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This is a mix-in class that injects instrument gets and sets into</span>
<span class="sd">        traitlet decriptors.</span>
<span class="sd">        </span>
<span class="sd">        Classes that use Remotify as a mix-in should do so as follows:</span>
<span class="sd">        </span>
<span class="sd">        class MyRemoteTraitletClass(RemoteTraitMixIn,traitlets.TraitletClass):</span>
<span class="sd">            pass</span>
<span class="sd">            </span>
<span class="sd">        In other words, the class should inherit RemoteTraitMixIn first and the</span>
<span class="sd">        desired traitlet type second.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Undefined</span>
    <span class="n">write_only</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;read_only&#39;</span><span class="p">,</span> <span class="s1">&#39;write_only&#39;</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">write_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span> <span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
                                                <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span>
                                                <span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span><span class="p">,</span>
                                                <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="o">=</span> <span class="n">write_only</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">setter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">setter</span><span class="o">=</span><span class="n">setter</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">getter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">getter</span><span class="o">=</span><span class="n">getter</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_doc__</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__make_doc__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attr_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_attrs</span><span class="p">:</span>
            <span class="n">attr_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">=</span><span class="si">{v}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">))))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span>  <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                  <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr_pairs</span><span class="p">),</span>
                  <span class="s1">&#39;help&#39;</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">}</span>
        <span class="k">return</span> <span class="s1">&#39;labbench.</span><span class="si">{name}</span><span class="s1">(</span><span class="si">{attrs}</span><span class="s1">)</span><span class="se">\n</span><span class="si">{help}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload the traitlet&#39;s get method to inject a call to get</span>
<span class="sd">            from the remote device</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">(</span><span class="s1">&#39;tried to read remotelet value, but it is write-only and has not been set yet&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;getter&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;getter&#39;</span><span class="p">](</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span><span class="c1"># self.command is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">command_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CommandNotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RemoteStateError</span><span class="p">(</span><span class="s1">&#39;no command or getter defined - cannot get state from device&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait_cls</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_cls</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">set</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload the traitlet&#39;s get method to inject a call to a</span>
<span class="sd">            method to set the state on a remote device.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setter&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">](</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span><span class="c1"># self.command is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">command_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CommandNotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RemoteStateError</span><span class="p">(</span><span class="s1">&#39;no command or setter defined - cannot set state to device&#39;</span><span class="p">)</span>

        <span class="n">rd_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait_cls</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_cls</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_cls</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">rd_only</span>
        <span class="k">except</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">devalidate</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload this function to convert from the python representation of the</span>
<span class="sd">            into the representation to be sent to the remote device</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;getter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_trait_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__cached_trait_cls</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">RemoteTraitMixIn</span><span class="p">):</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">__cached_trait_cls</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">return</span> <span class="n">c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;could not identify base any parent Trait class&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Int</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CInt</span><span class="p">):</span>
    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">RemoteTraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span>

<span class="k">class</span> <span class="nc">Float</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CFloat</span><span class="p">):</span>
    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;step&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">RemoteTraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CUnicode</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="k">class</span> <span class="nc">Complex</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CComplex</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Bytes</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CBytes</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="k">class</span> <span class="nc">EnumBytes</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CBytes</span><span class="p">):</span>
    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span><span class="s1">&#39;case_sensitive&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">RemoteTraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[],</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must define at least one enum value&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span>
        <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="s1">&#39;castable to &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; (case insensitive)&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">devalidate</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">Dict</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">(</span><span class="s1">&#39;Dict type casting needs to be implemented with a .getter decorator&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">devalidate</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">Bool</span><span class="p">(</span><span class="n">RemoteTraitMixIn</span><span class="p">,</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CBool</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trues</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">,</span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">falses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;off&#39;</span><span class="p">,</span><span class="s1">&#39;false&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trues</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trues</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_falses</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">falses</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>       
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trues</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_falses</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need a boolean or numeric value to convert to integer&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">devalidate</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_falses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DisconnectedBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This &quot;Null Backend&quot; implementation exists to give sensible error</span>
<span class="sd">        messages on attempts to use a backend that is not connected.        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dev</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; dev may be a class or an object for error feedback</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span> <span class="o">=</span> <span class="n">dev</span>
        
    <span class="k">def</span> <span class="nf">__getattribute__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s1">&#39;need to connect first to access backend.</span><span class="si">{key}</span><span class="s1"> in </span><span class="si">{clsname}</span><span class="s1"> instance (resource=</span><span class="si">{resource}</span><span class="s1">)&#39;</span>\
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">clsname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Device</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;`Device` is the base class common to all labbench</span>
<span class="sd">        drivers, regardless of backend types.</span>
<span class="sd">                </span>
<span class="sd">        Drivers that subclass `Device` inherit</span>
<span class="sd">        </span>
<span class="sd">        * device connection management via context management (the `with` statement)</span>
<span class="sd">        * test state management for easy test logging and extension to UI</span>
<span class="sd">        * a simple object protocol for stylistic consistency between drivers</span>
<span class="sd">        </span>
<span class="sd">        :param resource: resource identifier, with type and format determined by backend (see specific subclasses for details)</span>
<span class="sd">        :param **connection_params: additional backend-specific connection parameters</span>

<span class="sd">        .. note::</span>
<span class="sd">            Use `Device` by subclassing it only if you are</span>
<span class="sd">            implementing a driver that needs a new type of backend. </span>

<span class="sd">            Several types of backends have already been implemented</span>
<span class="sd">            as part of labbench:</span>
<span class="sd">                </span>
<span class="sd">                * VISADevice exposes a pyvisa backend for VISA Instruments</span>
<span class="sd">                * CommandLineWrapper exposes a threaded pipes backend for command line tools</span>
<span class="sd">                * Serial exposes a pyserial backend for serial port communication</span>
<span class="sd">                * DotNetDevice exposes a pythonnet for wrapping dotnet libraries</span>
<span class="sd">                </span>
<span class="sd">            (and others). If you are implementing a driver that uses one of</span>
<span class="sd">            these backends, inherit from the corresponding class above, not</span>
<span class="sd">            `Device`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">resource</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="s1">&#39;.. attribute::resource is the data needed to make a connection to a device. its type and format are determined by the subclass implementation&#39;</span>
    
    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Base class for accessing the local and remote state</span>
<span class="sd">            parameters of a device.  Normally,</span>
<span class="sd">            a device driver implemented as a :class:`Device` subclass</span>
<span class="sd">            should add driver-specific states by subclassing this class.</span>
<span class="sd">            </span>
<span class="sd">            Instantiating :class:`Device` (or one of its subclasses)</span>
<span class="sd">            automatically instantiate this class as well, so there</span>
<span class="sd">            is no need to instantiate it manually.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">connected</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39; indicates whether the :class:`Device` instance is connected &#39;&#39;&#39;</span>
    
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">HasTraits</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39; .. attribute::state is the backend that controls communication with the device.</span>
<span class="sd">        it is to be set in `connect` and `disconnect` by the subclass that implements the backend.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Backend classes *must* overload these</span>
    <span class="c1"># </span>
    <span class="k">def</span> <span class="nf">connect</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Backend implementations overload this to open a backend</span>
<span class="sd">            connection to the resource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;need to complete backend implementation by implementing a connect method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnect</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Backend implementations must overload this to disconnect an</span>
<span class="sd">            existing connection to the resource encapsulated in the object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;need to complete backend implementation by implementing a disconnect method&#39;</span><span class="p">)</span>
    
    <span class="c1"># Backend classes may optionally overload these, and do not need to call the parents</span>
    <span class="c1"># defined here</span>
    <span class="k">def</span> <span class="nf">command_get</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Read a setting from a remote instrument that has a trait attribute</span>
<span class="sd">            ``attr&#39;&#39; in type(self).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="n">CommandNotImplementedError</span><span class="p">(</span><span class="s1">&#39;state &quot;</span><span class="si">{attr}</span><span class="s1">&quot; is defined but not implemented! implement </span><span class="si">{cls}</span><span class="s1">.command_set, or implement a setter for </span><span class="si">{cls}</span><span class="s1">.state.</span><span class="si">{attr}</span><span class="s1">&#39;</span>\
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">trait</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">command_set</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Apply an instrument setting to the instrument. The value ``value&#39;&#39;</span>
<span class="sd">            will be applied to the trait attriute ``attr&#39;&#39; in type(self).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="n">CommandNotImplementedError</span><span class="p">(</span><span class="s1">&#39;state &quot;</span><span class="si">{attr}</span><span class="s1">&quot; is defined but not implemented! implement </span><span class="si">{cls}</span><span class="s1">.command_get, or implement a getter for </span><span class="si">{cls}</span><span class="s1">.state.</span><span class="si">{attr}</span><span class="s1">&#39;</span>\
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">trait</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setup</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Called each time a device is instantiated</span>
<span class="sd">            after everything else is ready.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>
            
    <span class="c1"># Subclasses *may* overload the following methods, but should call this</span>
    <span class="c1"># parent method like so:</span>
    <span class="c1">#</span>
    <span class="c1"># super(Device, self).__init__(resource)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>

        <span class="c1"># Set runtime parameters as appropriate</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">connection_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;tried to set connection parameter </span><span class="si">{k}</span><span class="s1">, which is not supported by </span><span class="si">{clsname}</span><span class="s1">&#39;</span>\
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">clsname</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">connection_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="c1"># Instantiate state, and observe connection state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Redirect access to connect and disconnect to wrappers that ensure</span>
<span class="sd">            self.state.connected gets set directly</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">connect_wrapper</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{clsname}</span><span class="s1">.connect() call (resource </span><span class="si">{resource}</span><span class="s1">) on instance that is already connected&#39;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clsname</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)))</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
                
                <span class="c1"># Work around the readonlyness of state.connected to set it True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="s1">&#39;connected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="s1">&#39;connected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">disconnect_wrapper</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
                
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
                    <span class="c1"># Work around the readonlyness of state.connected to set it True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="s1">&#39;connected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="s1">&#39;connected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;connect&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">actual</span><span class="p">:</span>
            <span class="n">connect_wrapper</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="k">return</span> <span class="n">connect_wrapper</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;disconnect&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">actual</span><span class="p">:</span>
            <span class="n">disconnect_wrapper</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="k">return</span> <span class="n">disconnect_wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;backend&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;not connected - connect first to access communication backend&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                
    <span class="k">def</span> <span class="nf">__enter__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(resource=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span>

<span class="k">class</span> <span class="nc">StateAggregator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Aggregation states information from multiple</span>
<span class="sd">        devices. This can be the basis automatic database logging or user interface.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Map the state instance of a device (key) to a name (value)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># These dictionaries are keyed by Device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__always</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__never</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">make_timestamp</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate a timestamp</span>

<span class="sd">            :returns: string</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">key</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate a name for a state based on the names of</span>
<span class="sd">            a device and one of its remotelets</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">_</span><span class="si">{attr}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                                      <span class="n">attr</span><span class="o">=</span><span class="n">state_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__on_set_callback</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Callback for changes observed when device states are set.</span>

<span class="sd">        :param dict change: callback info dictionary generated by traitlets</span>
<span class="sd">        :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]],</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">set_device_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Manually choose device name for a device instance.</span>

<span class="sd">            :param dict mapping: name mapping, formatted as {device_object: &#39;device name&#39;}</span>
<span class="sd">            :returns: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Can only monitor a device that is an instance of a subclass of Device&#39;</span><span class="p">)</span>        
                
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">v</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
    
    <span class="k">def</span> <span class="nf">observe</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39; Configure Each time a device state is set from python,</span>
<span class="sd">            intercept the value to include in the aggregate</span>
<span class="sd">            state.</span>
<span class="sd">                        </span>
<span class="sd">            Device may be a single device instance, or an</span>
<span class="sd">            several devices in an iterable (such as a list</span>
<span class="sd">            or tuple) to apply to each one.</span>

<span class="sd">            Subsequent calls to :func:`observe` replace</span>
<span class="sd">            the existing list of observed states for each</span>
<span class="sd">            device.</span>

<span class="sd">            :param devices: Device instance or iterable of Device instances</span>
<span class="sd">            :param bool changes: Whether to automatically log each time a state is set for the supplied device(s)</span>
<span class="sd">            :param always: name (or iterable of multiple names) of states to actively update on each call to get()</span>
<span class="sd">            :param never: name (or iterable of multiple names) of states to exclude from aggregated result (supercedes :param:`always`)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">devices</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">always</span> <span class="o">=</span> <span class="p">[</span><span class="n">always</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Can only monitor a device that is an instance of a subclass of Device&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__whoisthis</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Could not automatically determine unique names of device instances!</span>
<span class="s1">                               Set manually with the set_label method &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">unobserve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">always</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">never</span>

    <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Aggregate and return the current device states as configured</span>
<span class="sd">            with :func:`observe`.</span>

<span class="sd">            :returns: dictionary of aggregated states. Keys are str formatted</span>
<span class="sd">            according to the :func:`key` (defaults to</span>
<span class="sd">            &#39;{device name}_{state name}&#39;). Values are the type and value of</span>
<span class="sd">            the corresponding state of the device instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">device_state</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Perform gets for each state called out in manual_include</span>
            <span class="k">if</span> <span class="n">device_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device_state</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">device_state</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                
            <span class="c1"># Remove keys corresponding with self.__never</span>
            <span class="k">if</span> <span class="n">device_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device_state</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">attr</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spy</span><span class="p">()</span>
        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_timestamp</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>
        
    <span class="k">def</span> <span class="nf">spy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a dictionary of the most recently observed states</span>
<span class="sd">            without pulling new states from any devices (but including</span>
<span class="sd">            states included to `always` aggregate). Does not</span>
<span class="sd">            include the current timestamp.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__whoisthis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">from_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Introspect into the caller to find the name of an object .</span>

<span class="sd">        :param obj: device instance</span>
<span class="sd">        :param from_depth: number of callers outside of the current frame</span>
<span class="sd">        :return: name of the Device</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">(</span><span class="n">from_depth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">k</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know who I am and I can&#39;t figure it out :(&quot;</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../ssmdevices.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright  does not apply.

This software was developed by employees of the National Institute of Standards and Technology (NIST), an agency of the
Federal Government. Pursuant to title 17 United States Code Section 105, works of NIST employees are not subject to
copyright protection in the United States and are considered to be in the public domain. Permission to freely use, copy,
modify, and distribute this software and its documentation without fee is hereby granted, provided that this notice and
disclaimer of warranty appears in all copies.

THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING,
BUT NOT LIMITED TO, ANY WARRANTY THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM INFRINGEMENT, AND ANY WARRANTY THAT THE
DOCUMENTATION WILL CONFORM TO THE SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT SHALL
NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT, INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES,
ARISING OUT OF, RESULTING FROM, OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON WARRANTY,
CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER
OR NOT LOSS WAS SUSTAINED FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES PROVIDED HEREUNDER.

Distributions of NIST software should also include copyright and licensing statements of any third-party software
that are legally bundled with the code in compliance with the conditions of those licenses..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>